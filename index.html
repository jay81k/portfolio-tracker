<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        input[type='date']::-webkit-calendar-picker-indicator { filter: invert(var(--date-invert, 1)); }
        * { transition: background-color 0.2s ease, color 0.1s ease, border-color 0.15s ease; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // SVG Icons
        const Upload = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        );
        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        );
        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );
        const Home = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        );
        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );
        const Edit = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );
        const Settings = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        );
        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        window.storage = {
            async get(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? { key, value, shared: false } : null;
                } catch (e) { return null; }
            },
            async set(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return { key, value, shared: false };
                } catch (e) { return null; }
            }
        };

        function PortfolioTracker() {
            const [trades, setTrades] = useState([]);
            const tradesRef = React.useRef([]);
            const [isLoading, setIsLoading] = useState(true);
            const [showCSVUpload, setShowCSVUpload] = useState(false);
            const [showAddTrade, setShowAddTrade] = useState(false);
            const [showEditTrade, setShowEditTrade] = useState(false);
            const [editingTrade, setEditingTrade] = useState(null);
            const [processingCSV, setProcessingCSV] = useState(false);
            const [view, setView] = useState('dashboard');
            const [tradeView, setTradeView] = useState('all');
            const [timeframe, setTimeframe] = useState('ALL');
            const [currentPrices, setCurrentPrices] = useState({});
            const [fetchingPrices, setFetchingPrices] = useState(false);
            const [manualPrices, setManualPrices] = useState({});
            const [editingPrice, setEditingPrice] = useState(null); // symbol being manually edited
            const [todaysOpeningPrices, setTodaysOpeningPrices] = useState({}); // Prices at start of day for intraday P/L
            const [prevClosePrices, setPrevClosePrices] = useState({}); // Previous day's closing prices
            
            const [formData, setFormData] = useState({
                symbol: '', name: '', qty: '', entryPrice: '', entryDate: new Date().toISOString().split('T')[0],
                exitDate: '', exitPrice: '', fees: '0', profit: '0', dividend: '0', notes: '', direction: 'long'
            });
            const [showPartialExit, setShowPartialExit] = useState(false);
            const [partialExitForm, setPartialExitForm] = useState({
                qty: '', exitPrice: '', exitDate: new Date().toISOString().split('T')[0]
            });
            const [editingPartialExit, setEditingPartialExit] = useState(null);
            const [partialType, setPartialType] = useState('exit');
            const [partialAddForm, setPartialAddForm] = useState({
                qty: '', price: '', date: new Date().toISOString().split('T')[0]
            });
            const [dividendAddVal, setDividendAddVal] = useState('');
            const [dividendAddActive, setDividendAddActive] = useState(false);
            const [expandedTrade, setExpandedTrade] = useState(null);
            const [sortColumn, setSortColumn] = useState(null);
            const [sortDirection, setSortDirection] = useState('asc'); // 'asc' or 'desc'
            const [searchTerm, setSearchTerm] = useState('');
            const [chartTimeframe, setChartTimeframe] = useState('ALL');
            const [showSettingsMenu, setShowSettingsMenu] = useState(false);
            const [showDataMenu, setShowDataMenu] = useState(false);
            const [fetchingName, setFetchingName] = useState(false);
            const [portfolios, setPortfolios] = useState(() => {
                try {
                    const stored = localStorage.getItem('pt_portfolios');
                    return stored ? JSON.parse(stored) : [{ id: 'default', name: 'My Portfolio' }];
                } catch(e) { return [{ id: 'default', name: 'My Portfolio' }]; }
            });
            const [activePortfolioId, setActivePortfolioId] = useState(() => {
                try { return localStorage.getItem('pt_active_portfolio') || 'default'; } catch(e) { return 'default'; }
            });
            const [showAddPortfolio, setShowAddPortfolio] = useState(false);
            const [newPortfolioName, setNewPortfolioName] = useState('');
            const [isDark, setIsDark] = useState(() => {
                try { return localStorage.getItem('pt_theme') !== 'light'; } catch(e) { return true; }
            });
            const toggleTheme = () => {
                setIsDark(d => {
                    const next = !d;
                    try { localStorage.setItem('pt_theme', next ? 'dark' : 'light'); } catch(e) {}
                    return next;
                });
            };

            const T = isDark ? {
                // Dark theme
                pageBg:      '#000000',
                panelBg:     '#0a0a0a',
                surfaceBg:   '#111111',
                raisedBg:    '#1a1a1a',
                hoverBg:     '#1a1a1a',
                inputBg:     '#0a0a0a',
                modalOverlay:'rgba(0,0,0,0.85)',
                border:      '#1a1a1a',
                borderMid:   '#222222',
                borderStrong:'#333333',
                textPrimary: '#e0e0e0',
                textSecondary:'#999999',
                textMuted:   '#666666',
                textFaint:   '#444444',
                textVeryFaint:'#333333',
                green:       '#00ff88',
                greenBg:     'rgba(0,255,136,0.15)',
                greenBgDim:  'rgba(0,255,136,0.08)',
                red:         '#ff4444',
                redBg:       'rgba(255,68,68,0.15)',
                blue:        '#00ccff',
                blueBg:      'rgba(0,204,255,0.15)',
                amber:       '#ffaa00',
                amberBg:     'rgba(255,170,0,0.15)',
                shadowMd:    '0 8px 24px rgba(0,0,0,0.5)',
                shadowLg:    '0 4px 12px rgba(0,0,0,0.5)',
                chartGrid:   '#1a1a1a',
                chartTick:   '#555555',
                chartTooltipBg: '#111111',
                chartTooltipBorder: '#333333',
                tableRowEven:'#0a0a0a',
                tableRowOdd: '#0d0d0d',
            } : {
                // Light theme
                pageBg:      '#f0f2f5',
                panelBg:     '#ffffff',
                surfaceBg:   '#f8f9fa',
                raisedBg:    '#f0f2f5',
                hoverBg:     '#e8eaed',
                inputBg:     '#ffffff',
                modalOverlay:'rgba(0,0,0,0.5)',
                border:      '#e2e5e9',
                borderMid:   '#d1d5db',
                borderStrong:'#b0b7c3',
                textPrimary: '#111827',
                textSecondary:'#4b5563',
                textMuted:   '#6b7280',
                textFaint:   '#9ca3af',
                textVeryFaint:'#d1d5db',
                green:       '#059669',
                greenBg:     'rgba(5,150,105,0.12)',
                greenBgDim:  'rgba(5,150,105,0.06)',
                red:         '#dc2626',
                redBg:       'rgba(220,38,38,0.1)',
                blue:        '#0284c7',
                blueBg:      'rgba(2,132,199,0.1)',
                amber:       '#d97706',
                amberBg:     'rgba(217,119,6,0.1)',
                shadowMd:    '0 8px 24px rgba(0,0,0,0.12)',
                shadowLg:    '0 4px 12px rgba(0,0,0,0.1)',
                chartGrid:   '#e5e7eb',
                chartTick:   '#9ca3af',
                chartTooltipBg: '#ffffff',
                chartTooltipBorder: '#e2e5e9',
                tableRowEven:'#ffffff',
                tableRowOdd: '#f8f9fa',
            };


            // Quick local lookup for very common symbols (instant, no API call needed)
            const KNOWN_SYMBOLS = {
                'AAPL': 'Apple Inc', 'MSFT': 'Microsoft Corp', 'GOOGL': 'Alphabet Inc', 'GOOG': 'Alphabet Inc',
                'AMZN': 'Amazon.com Inc', 'META': 'Meta Platforms Inc', 'TSLA': 'Tesla Inc',
                'NVDA': 'NVIDIA Corp', 'BRK.B': 'Berkshire Hathaway Inc', 'BRK.A': 'Berkshire Hathaway Inc',
                'JPM': 'JPMorgan Chase & Co', 'V': 'Visa Inc', 'JNJ': 'Johnson & Johnson',
                'WMT': 'Walmart Inc', 'PG': 'Procter & Gamble Co', 'MA': 'Mastercard Inc',
                'HD': 'Home Depot Inc', 'DIS': 'Walt Disney Co', 'BAC': 'Bank of America Corp',
                'ADBE': 'Adobe Inc', 'NFLX': 'Netflix Inc', 'CRM': 'Salesforce Inc',
                'AMD': 'Advanced Micro Devices', 'INTC': 'Intel Corp', 'QCOM': 'Qualcomm Inc',
                'PYPL': 'PayPal Holdings Inc', 'SHOP': 'Shopify Inc', 'SQ': 'Block Inc',
                'COIN': 'Coinbase Global Inc', 'PLTR': 'Palantir Technologies',
                'SPY': 'SPDR S&P 500 ETF', 'QQQ': 'Invesco QQQ Trust', 'IWM': 'iShares Russell 2000 ETF',
                'VTI': 'Vanguard Total Stock Market ETF', 'VOO': 'Vanguard S&P 500 ETF',
                'JPST': 'JPM Ultra-Short Income ETF', 'ARKK': 'ARK Innovation ETF',
                'GLD': 'SPDR Gold Shares', 'SLV': 'iShares Silver Trust',
                'XLF': 'Financial Select Sector SPDR', 'XLE': 'Energy Select Sector SPDR',
                // Canadian symbols
                'CASH.TO': 'GX High Interest Savings ETF', 'BEPC.TO': 'Brookfield Renewable Corp',
                'BNS.TO': 'Bank of Nova Scotia', 'RY.TO': 'Royal Bank of Canada',
                'TD.TO': 'Toronto-Dominion Bank', 'ENB.TO': 'Enbridge Inc',
                'CNQ.TO': 'Canadian Natural Resources', 'CP.TO': 'Canadian Pacific Kansas City',
                'CNR.TO': 'Canadian National Railway', 'BCE.TO': 'BCE Inc',
                'T.TO': 'Telus Corp', 'MFC.TO': 'Manulife Financial Corp',
                'SU.TO': 'Suncor Energy Inc', 'ABX.TO': 'Barrick Gold Corp',
                'SHOP.TO': 'Shopify Inc', 'BAM.TO': 'Brookfield Asset Management',
                'ATD.TO': 'Alimentation Couche-Tard', 'WCN.TO': 'Waste Connections Inc',
                'TRI.TO': 'Thomson Reuters Corp', 'CSU.TO': 'Constellation Software',
            };

            const fetchSymbolName = async (symbol) => {
                if (!symbol || symbol.length < 1) return null;
                const cleanSymbol = symbol.toUpperCase().trim();

                // 1. Check local cache first (instant)
                if (KNOWN_SYMBOLS[cleanSymbol]) return KNOWN_SYMBOLS[cleanSymbol];

                // 2. Use Yahoo Finance — free, no API key, same source used for prices
                const endpoints = [
                    `https://query1.finance.yahoo.com/v8/finance/chart/${cleanSymbol}?interval=1d&range=1d`,
                    `https://query2.finance.yahoo.com/v8/finance/chart/${cleanSymbol}?interval=1d&range=1d`,
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${cleanSymbol}?interval=1d&range=1d`)}`,
                    `https://corsproxy.io/?${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${cleanSymbol}?interval=1d&range=1d`)}`,
                ];
                for (const url of endpoints) {
                    try {
                        const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
                        if (!response.ok) continue;
                        const data = await response.json();
                        const meta = data?.chart?.result?.[0]?.meta;
                        const name = meta?.longName || meta?.shortName;
                        if (name && name.trim().length > 1) return name.trim();
                    } catch (e) {
                        // try next endpoint
                    }
                }

                return null;
            };

            // Load trades on mount and whenever portfolio switches
            useEffect(() => {
                loadTrades(activePortfolioId);
            }, [activePortfolioId]);

            const savePortfolios = (newPortfolios) => {
                setPortfolios(newPortfolios);
                try { localStorage.setItem('pt_portfolios', JSON.stringify(newPortfolios)); } catch(e) {}
            };

            const handleAddPortfolio = () => {
                const name = newPortfolioName.trim();
                if (!name) return;
                const id = 'portfolio_' + Date.now();
                const updated = [...portfolios, { id, name }];
                savePortfolios(updated);
                // Switch to new portfolio (it starts empty)
                setActivePortfolioId(id);
                try { localStorage.setItem('pt_active_portfolio', id); } catch(e) {}
                setTrades([]);
                setNewPortfolioName('');
                setShowAddPortfolio(false);
                setShowSettingsMenu(false);
            };

            const handleSwitchPortfolio = (id) => {
                setActivePortfolioId(id);
                try { localStorage.setItem('pt_active_portfolio', id); } catch(e) {}
                // Clear price state so the new portfolio's stats are calculated fresh
                setCurrentPrices({});
                setPrevClosePrices({});
                setManualPrices({});
                setTodaysOpeningPrices({});
            };

            const handleDeletePortfolio = async (id) => {
                if (portfolios.length <= 1) { alert("You can't delete your only portfolio."); return; }
                if (!confirm('Delete this portfolio and all its trades? This cannot be undone.')) return;
                // Remove its trades from storage
                await window.storage.set(`portfolio_trades_${id}`, JSON.stringify([]));
                const updated = portfolios.filter(p => p.id !== id);
                savePortfolios(updated);
                // If deleting the active one, switch to first remaining
                if (activePortfolioId === id) {
                    handleSwitchPortfolio(updated[0].id);
                }
            };
            // Sync body background with theme
            useEffect(() => {
                document.body.style.background = T.pageBg;
                document.body.style.color = T.textPrimary;
                document.documentElement.style.setProperty('--date-invert', isDark ? '1' : '0');
            }, [isDark]);



            useEffect(() => {
                const openTrades = trades.filter(t => !t.exitDate);
                if (openTrades.length > 0) {
                    fetchCurrentPrices();
                    const interval = setInterval(fetchCurrentPrices, 60000);
                    return () => clearInterval(interval);
                }
            }, [trades]);

            const fetchPriceForSymbol = async (symbol) => {
                // Clean symbol for Yahoo (e.g. BBD-B.TO stays as-is, Canadian stocks use .TO)
                const yahooSymbol = symbol;

                // Strategy 1: Direct Yahoo Finance v8
                const attempts = [
                    () => fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=5d`, { headers: { 'Accept': 'application/json' } }),
                    () => fetch(`https://query2.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=5d`, { headers: { 'Accept': 'application/json' } }),
                    // Strategy 2: allorigins CORS proxy
                    () => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=5d`)}`),
                    // Strategy 3: corsproxy.io
                    () => fetch(`https://corsproxy.io/?${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=5d`)}`),
                ];

                for (const attempt of attempts) {
                    try {
                        const response = await attempt();
                        if (!response.ok) continue;
                        const data = await response.json();
                        const result = data?.chart?.result?.[0];
                        const currentPrice = result?.meta?.regularMarketPrice;
                        
                        // Get previous close from actual chart data
                        let previousClose = null;
                        const timestamps = result?.timestamp;
                        const closes = result?.indicators?.quote?.[0]?.close;
                        
                        if (timestamps && closes && closes.length > 1) {
                            // Get the last non-null close before the most recent one
                            for (let i = closes.length - 2; i >= 0; i--) {
                                if (closes[i] !== null && closes[i] !== undefined) {
                                    previousClose = closes[i];
                                    break;
                                }
                            }
                        }
                        
                        if (currentPrice && currentPrice > 0) {
                            const companyName = result?.meta?.longName || result?.meta?.shortName || null;
                            console.log(`Got price for ${symbol}: $${currentPrice}, prev close: $${previousClose}`);
                            return { currentPrice, previousClose, companyName };
                        }
                    } catch (e) {
                        // silently try next
                    }
                }
                console.warn(`All price fetch attempts failed for ${symbol}`);
                return null;
            };

            const fetchCurrentPrices = async () => {
                const openTrades = trades.filter(t => !t.exitDate);
                if (openTrades.length === 0) {
                    setCurrentPrices({}); // Clear all prices if no open trades
                    setPrevClosePrices({});
                    return;
                }
                setFetchingPrices(true);
                const symbols = [...new Set(openTrades.map(t => t.symbol))];
                const newPrices = {};
                const newPrevCloses = {};
                const updatedTrades = [...trades];
                let namesUpdated = false;
                
                // Only keep prices for currently open positions
                await Promise.all(symbols.map(async (symbol) => {
                    // Try to preserve existing price first
                    if (currentPrices[symbol]) {
                        newPrices[symbol] = currentPrices[symbol];
                    }
                    if (prevClosePrices[symbol]) {
                        newPrevCloses[symbol] = prevClosePrices[symbol];
                    }
                    // Then fetch new price data
                    const priceData = await fetchPriceForSymbol(symbol);
                    if (priceData !== null) {
                        newPrices[symbol] = priceData.currentPrice;
                        if (priceData.previousClose) {
                            newPrevCloses[symbol] = priceData.previousClose;
                        }
                    }
                    
                    // Fetch name for ALL trades with this symbol that don't have a name (not just open)
                    const tradesNeedingName = updatedTrades.filter(t => t.symbol === symbol && (!t.name || t.name.trim() === ''));
                    if (tradesNeedingName.length > 0) {
                        // Prefer the name already returned by the price fetch (free, no extra call)
                        const nameFromPrice = priceData?.companyName;
                        const name = nameFromPrice || await fetchSymbolName(symbol);
                        if (name) {
                            console.log(`Got name: ${name}, updating trades`);
                            tradesNeedingName.forEach(trade => {
                                trade.name = name;
                            });
                            namesUpdated = true;
                        }
                    }
                }));
                
                setCurrentPrices(newPrices);
                setPrevClosePrices(newPrevCloses);
                
                // Save updated trades if any names were added
                if (namesUpdated) {
                    console.log('Saving trades with updated names...');
                    await saveTrades(updatedTrades);
                }
                
                // Set opening prices if this is the first fetch of the day
                const today = new Date().toISOString().split('T')[0];
                if (Object.keys(todaysOpeningPrices).length === 0 && Object.keys(newPrices).length > 0) {
                    setTodaysOpeningPrices(newPrices);
                    await window.storage.set('portfolio_opening_prices', JSON.stringify({ date: today, prices: newPrices }));
                }
                
                setFetchingPrices(false);
            };

            const loadTrades = async (pid) => {
                setIsLoading(true);
                setTrades([]); // always reset before loading new portfolio
                const resolvedId = pid || activePortfolioId;
                const key = `portfolio_trades_${resolvedId}`;

                // One-time migration: move old 'portfolio_trades' into 'portfolio_trades_default'
                const legacyData = await window.storage.get('portfolio_trades');
                const defaultData = await window.storage.get('portfolio_trades_default');
                if (legacyData?.value && !defaultData?.value) {
                    await window.storage.set('portfolio_trades_default', legacyData.value);
                }
                const stored = await window.storage.get(key);
                if (stored?.value) {
                    try { 
                        const loadedTrades = JSON.parse(stored.value);
                        // Migrate old trades to new structure
                        const migratedTrades = loadedTrades.map(trade => ({
                            ...trade,
                            originalQty: trade.originalQty || trade.qty,
                            partialExits: trade.partialExits || [],
                            partialAdds: trade.partialAdds || [],
                            direction: trade.direction || 'long'
                        }));
                        setTrades(migratedTrades);
                    }
                    catch (e) { console.error('Failed to parse trades:', e); setTrades([]); }
                } else {
                    setTrades([]); // portfolio exists but has no saved trades yet
                }
                
                // Load today's opening prices
                const today = new Date().toISOString().split('T')[0];
                const storedOpeningPrices = await window.storage.get('portfolio_opening_prices');
                if (storedOpeningPrices?.value) {
                    try {
                        const parsed = JSON.parse(storedOpeningPrices.value);
                        // Check if the stored prices are from today
                        if (parsed.date === today) {
                            setTodaysOpeningPrices(parsed.prices);
                        } else {
                            // New day - reset opening prices
                            setTodaysOpeningPrices({});
                        }
                    } catch (e) { console.error('Failed to parse opening prices:', e); }
                }
                
                setIsLoading(false);
            };

            // Keep tradesRef current so closures never read stale trades state
            useEffect(() => { tradesRef.current = trades; }, [trades]);

            const saveTrades = async (newTrades) => {
                setTrades(newTrades);
                await window.storage.set(`portfolio_trades_${activePortfolioId}`, JSON.stringify(newTrades));
            };

            const extractDividend = (text) => {
                if (!text) return 0;
                const patterns = [/(\d+\.?\d*)\$?\s*[Dd]ividend/, /[Dd]ividend[s]?\s*\$?(\d+\.?\d*)/, /(\d+\.?\d*)\s*in\s*dividends/i];
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) return parseFloat(match[1]) || 0;
                }
                return 0;
            };

            const parseCSV = (text) => {
                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length < 2) throw new Error('CSV must have headers and data');
                const parseCSVLine = (line) => {
                    const result = []; let current = ''; let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                        else current += char;
                    }
                    result.push(current.trim());
                    return result;
                };
                const headers = parseCSVLine(lines[0]);
                const symbolIdx = headers.findIndex(h => h === 'Symbol');
                const nameIdx = headers.findIndex(h => h === 'Name');
                const qtyIdx = headers.findIndex(h => h === 'Qty');
                const originalQtyIdx = headers.findIndex(h => h === 'Original Qty');
                const entryDateIdx = headers.findIndex(h => h === 'Entry Date');
                const entryPriceIdx = headers.findIndex(h => h === 'Entry Price');
                const exitDateIdx = headers.findIndex(h => h === 'Exit Date');
                const exitPriceIdx = headers.findIndex(h => h === 'Exit Price') !== -1 ? headers.findIndex(h => h === 'Exit Price') : headers.findIndex(h => h === 'Last');
                const totalChgIdx = headers.findIndex(h => h === 'Total Chg');
                const feesIdx = headers.findIndex(h => h === 'Fees');
                const profitIdx = headers.findIndex(h => h === 'Profit') !== -1 ? headers.findIndex(h => h === 'Profit') : headers.findIndex(h => h === 'Total Profit');
                const dividendIdx = headers.findIndex(h => h === 'Dividends');
                const notesIdx = headers.findIndex(h => h === 'Notes') !== -1 ? headers.findIndex(h => h === 'Notes') : headers.findIndex(h => h === 'Log');
                const partialExitsIdx = headers.findIndex(h => h === 'Partial Exits');
                const partialAddsIdx = headers.findIndex(h => h === 'Partial Adds');
                const directionIdx = headers.findIndex(h => h === 'Direction');
                if (symbolIdx === -1 || qtyIdx === -1 || entryPriceIdx === -1 || entryDateIdx === -1) {
                    throw new Error('Missing required columns in CSV');
                }
                const parsedTrades = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    const symbol = values[symbolIdx];
                    const qty = parseFloat(values[qtyIdx]);
                    const entryPrice = parseFloat(values[entryPriceIdx]);
                    const entryDate = values[entryDateIdx];
                    if (!symbol || isNaN(qty) || isNaN(entryPrice) || !entryDate) continue;
                    const exitDate = exitDateIdx !== -1 ? values[exitDateIdx] : '';
                    
                    // Calculate exit price from Total Chg if available
                    let exitPrice = null;
                    // Always use Total Chg to calculate exit price when available
                    if (totalChgIdx !== -1 && values[totalChgIdx] && values[totalChgIdx].trim() !== '') {
                        const totalChgStr = values[totalChgIdx].trim();
                        // Only parse if it's not "unch" or other non-numeric value
                        if (totalChgStr.toLowerCase() !== 'unch') {
                            const totalChg = parseFloat(totalChgStr);
                            if (!isNaN(totalChg)) {
                                exitPrice = entryPrice + totalChg;
                            }
                        }
                    }
                    // If we still don't have an exit price, try Exit Price / Last column
                    if (exitPrice === null && exitPriceIdx !== -1 && values[exitPriceIdx]) {
                        const parsed = parseFloat(values[exitPriceIdx]);
                        if (!isNaN(parsed)) exitPrice = parsed;
                    }

                    const notes = notesIdx !== -1 ? values[notesIdx] : '';

                    // Parse partial exits JSON if present
                    let partialExits = [];
                    if (partialExitsIdx !== -1 && values[partialExitsIdx] && values[partialExitsIdx].trim() !== '') {
                        try {
                            partialExits = JSON.parse(values[partialExitsIdx]);
                        } catch(e) { partialExits = []; }
                    }
                    // Parse partial adds JSON if present
                    let partialAdds = [];
                    if (partialAddsIdx !== -1 && values[partialAddsIdx] && values[partialAddsIdx].trim() !== '') {
                        try {
                            partialAdds = JSON.parse(values[partialAddsIdx]);
                        } catch(e) { partialAdds = []; }
                    }

                    // Dividend: use Dividends column if present, else extract from notes
                    const dividend = dividendIdx !== -1 && values[dividendIdx] !== undefined
                        ? parseFloat(values[dividendIdx]) || 0
                        : extractDividend(notes);

                    parsedTrades.push({
                        id: Date.now() + i,
                        symbol: symbol.trim(),
                        name: nameIdx !== -1 ? values[nameIdx].trim() : '',
                        qty,
                        originalQty: originalQtyIdx !== -1 ? parseFloat(values[originalQtyIdx]) || qty : qty,
                        entryPrice, entryDate,
                        exitDate: exitDate || null,
                        exitPrice: exitPrice,
                        fees: feesIdx !== -1 ? parseFloat(values[feesIdx]) || 0 : 0,
                        profit: profitIdx !== -1 ? parseFloat(values[profitIdx]) || 0 : 0,
                        dividend,
                        notes: notes.trim(),
                        partialExits,
                        partialAdds,
                        direction: directionIdx !== -1 && values[directionIdx] ? values[directionIdx].trim() : 'long'
                    });
                }
                return parsedTrades;
            };

            const handleCSVUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setProcessingCSV(true);
                try {
                    const text = await file.text();
                    const parsedTrades = parseCSV(text);
                    await saveTrades(parsedTrades);
                    setShowCSVUpload(false);
                    setView('trades');
                    alert(`Successfully imported ${parsedTrades.length} trades!`);
                } catch (error) {
                    console.error('CSV parsing error:', error);
                    alert(`Failed to parse CSV: ${error.message}`);
                } finally {
                    setProcessingCSV(false);
                    e.target.value = '';
                }
            };

            const handleAddTrade = async () => {
                if (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                const newTrade = {
                    id: Date.now(),
                    symbol: formData.symbol.toUpperCase().trim(),
                    name: formData.name.trim(),
                    qty: parseFloat(formData.qty),
                    originalQty: parseFloat(formData.qty),
                    entryPrice: parseFloat(formData.entryPrice),
                    entryDate: formData.entryDate,
                    exitDate: formData.exitDate || null,
                    exitPrice: formData.exitPrice ? parseFloat(formData.exitPrice) : null,
                    fees: parseFloat(formData.fees) || 0,
                    profit: parseFloat(formData.profit) || 0,
                    dividend: parseFloat(formData.dividend) || 0,
                    notes: formData.notes.trim(),
                    direction: formData.direction || 'long',
                    partialExits: [],
                    partialAdds: []
                };
                await saveTrades([...tradesRef.current, newTrade]);
                setShowAddTrade(false);
                setFormData({ symbol: '', name: '', qty: '', entryPrice: '', entryDate: new Date().toISOString().split('T')[0],
                    exitDate: '', exitPrice: '', fees: '0', profit: '0', dividend: '0', notes: '', direction: 'long' });
            };

            const handleDeleteTrade = async (id) => {
                if (confirm('Delete this trade?')) await saveTrades(tradesRef.current.filter(t => t.id !== id));
            };

            const handleAddPartialExit = async () => {
                if (!partialExitForm.qty || !partialExitForm.exitPrice || !partialExitForm.exitDate) {
                    alert('Please fill in all partial exit fields');
                    return;
                }
                const exitQty = parseFloat(partialExitForm.qty);
                // Current qty is already the remaining qty after previous partial exits
                const currentRemaining = editingTrade.qty;
                
                if (exitQty > currentRemaining) {
                    alert(`Only ${currentRemaining} shares remaining!`);
                    return;
                }

                const partialExit = {
                    id: Date.now(),
                    qty: exitQty,
                    exitPrice: parseFloat(partialExitForm.exitPrice),
                    exitDate: partialExitForm.exitDate,
                    profit: editingTrade.direction === 'short' ? (editingTrade.entryPrice - parseFloat(partialExitForm.exitPrice)) * exitQty : (parseFloat(partialExitForm.exitPrice) - editingTrade.entryPrice) * exitQty
                };

                const updatedTrade = {
                    ...editingTrade,
                    partialExits: [...(editingTrade.partialExits || []), partialExit],
                    qty: currentRemaining - exitQty
                };

                // Update formData profit to reflect the new partial exit
                const currentProfit = parseFloat(formData.profit) || 0;
                const newProfit = currentProfit + partialExit.profit;
                setFormData({...formData, profit: newProfit.toString(), qty: updatedTrade.qty.toString()});

                await saveTrades(tradesRef.current.map(t => t.id === editingTrade.id ? updatedTrade : t));
                setEditingTrade(updatedTrade);
                setShowPartialExit(false);
                setPartialExitForm({ qty: '', exitPrice: '', exitDate: new Date().toISOString().split('T')[0] });
            };

            const handleEditPartialExit = (partialExit) => {
                setEditingPartialExit(partialExit);
                setPartialExitForm({
                    qty: partialExit.qty.toString(),
                    exitPrice: partialExit.exitPrice.toString(),
                    exitDate: partialExit.exitDate
                });
                setShowPartialExit(true);
            };

            const handleUpdatePartialExit = async () => {
                if (!partialExitForm.qty || !partialExitForm.exitPrice || !partialExitForm.exitDate) {
                    alert('Please fill in all partial exit fields');
                    return;
                }
                
                const exitQty = parseFloat(partialExitForm.qty);
                const oldExit = editingPartialExit;
                const qtyDifference = exitQty - oldExit.qty;
                
                // Check if we have enough shares
                if (qtyDifference > editingTrade.qty) {
                    alert(`Only ${editingTrade.qty} shares remaining!`);
                    return;
                }

                const updatedPartialExit = {
                    ...oldExit,
                    qty: exitQty,
                    exitPrice: parseFloat(partialExitForm.exitPrice),
                    exitDate: partialExitForm.exitDate,
                    profit: editingTrade.direction === 'short' ? (editingTrade.entryPrice - parseFloat(partialExitForm.exitPrice)) * exitQty : (parseFloat(partialExitForm.exitPrice) - editingTrade.entryPrice) * exitQty
                };

                const profitDifference = updatedPartialExit.profit - oldExit.profit;

                const updatedTrade = {
                    ...editingTrade,
                    partialExits: editingTrade.partialExits.map(pe => 
                        pe.id === oldExit.id ? updatedPartialExit : pe
                    ),
                    qty: editingTrade.qty - qtyDifference
                };

                // Update formData profit to reflect the change
                const currentProfit = parseFloat(formData.profit) || 0;
                const newProfit = currentProfit + profitDifference;
                setFormData({...formData, profit: newProfit.toString(), qty: updatedTrade.qty.toString()});

                await saveTrades(tradesRef.current.map(t => t.id === editingTrade.id ? updatedTrade : t));
                setEditingTrade(updatedTrade);
                setEditingPartialExit(null);
                setShowPartialExit(false);
                setPartialExitForm({ qty: '', exitPrice: '', exitDate: new Date().toISOString().split('T')[0] });
            };

            const handleDeletePartialExit = async (partialExitId) => {
                if (!confirm('Delete this partial exit?')) return;
                
                const partialExit = editingTrade.partialExits.find(pe => pe.id === partialExitId);
                const updatedTrade = {
                    ...editingTrade,
                    partialExits: editingTrade.partialExits.filter(pe => pe.id !== partialExitId),
                    qty: editingTrade.qty + partialExit.qty
                };

                // Update formData profit by subtracting the deleted partial exit's profit
                const currentProfit = parseFloat(formData.profit) || 0;
                const newProfit = currentProfit - partialExit.profit;
                setFormData({...formData, profit: newProfit.toString(), qty: updatedTrade.qty.toString()});

                await saveTrades(tradesRef.current.map(t => t.id === editingTrade.id ? updatedTrade : t));
                setEditingTrade(updatedTrade);
            };

            const handleAddPartialAdd = async () => {
                if (!partialAddForm.qty || !partialAddForm.price || !partialAddForm.date) {
                    alert('Please fill in all fields');
                    return;
                }
                const addQty = parseFloat(partialAddForm.qty);
                const addPrice = parseFloat(partialAddForm.price);
                const currentQty = editingTrade.qty;
                const currentAvgCost = editingTrade.entryPrice;
                // Weighted average cost
                const newAvgCost = ((currentQty * currentAvgCost) + (addQty * addPrice)) / (currentQty + addQty);
                const partialAdd = {
                    id: Date.now(),
                    qty: addQty,
                    price: addPrice,
                    date: partialAddForm.date
                };
                const updatedTrade = {
                    ...editingTrade,
                    partialAdds: [...(editingTrade.partialAdds || []), partialAdd],
                    qty: currentQty + addQty,
                    originalQty: (editingTrade.originalQty || currentQty) + addQty,
                    entryPrice: parseFloat(newAvgCost.toFixed(4))
                };
                setFormData({...formData, entryPrice: newAvgCost.toFixed(4), qty: updatedTrade.qty.toString()});
                await saveTrades(tradesRef.current.map(t => t.id === editingTrade.id ? updatedTrade : t));
                setEditingTrade(updatedTrade);
                setShowPartialExit(false);
                setPartialAddForm({ qty: '', price: '', date: new Date().toISOString().split('T')[0] });
            };

            const handleDeletePartialAdd = async (partialAddId) => {
                if (!confirm('Delete this scale-in entry? Avg cost will be recalculated.')) return;
                const partialAdd = (editingTrade.partialAdds || []).find(pa => pa.id === partialAddId);
                if (!partialAdd) return;
                const currentQty = editingTrade.qty;
                const currentAvgCost = editingTrade.entryPrice;
                // Reverse the weighted average
                const prevQty = currentQty - partialAdd.qty;
                const prevAvgCost = prevQty > 0
                    ? ((currentQty * currentAvgCost) - (partialAdd.qty * partialAdd.price)) / prevQty
                    : currentAvgCost;
                const updatedTrade = {
                    ...editingTrade,
                    partialAdds: (editingTrade.partialAdds || []).filter(pa => pa.id !== partialAddId),
                    qty: prevQty,
                    originalQty: (editingTrade.originalQty || currentQty) - partialAdd.qty,
                    entryPrice: parseFloat(prevAvgCost.toFixed(4))
                };
                setFormData({...formData, entryPrice: prevAvgCost.toFixed(4), qty: updatedTrade.qty.toString()});
                await saveTrades(tradesRef.current.map(t => t.id === editingTrade.id ? updatedTrade : t));
                setEditingTrade(updatedTrade);
            };

            const handleEditTrade = (trade) => {
                setEditingTrade(trade);
                setFormData({
                    symbol: trade.symbol,
                    name: trade.name,
                    qty: trade.qty.toString(),
                    entryPrice: trade.entryPrice.toString(),
                    entryDate: trade.entryDate,
                    exitDate: trade.exitDate || '',
                    exitPrice: trade.exitPrice ? trade.exitPrice.toString() : '',
                    fees: trade.fees.toString(),
                    profit: trade.profit.toString(),
                    dividend: trade.dividend.toString(),
                    notes: trade.notes,
                    direction: trade.direction || 'long'
                });
                setShowEditTrade(true);
            };

            const handleUpdateTrade = async () => {
                if (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                const updatedTrade = {
                    ...editingTrade,
                    symbol: formData.symbol.toUpperCase().trim(),
                    name: formData.name.trim(),
                    qty: parseFloat(formData.qty),
                    entryPrice: parseFloat(formData.entryPrice),
                    entryDate: formData.entryDate,
                    exitDate: formData.exitDate || null,
                    exitPrice: formData.exitPrice ? parseFloat(formData.exitPrice) : null,
                    fees: parseFloat(formData.fees) || 0,
                    profit: parseFloat(formData.profit) || 0,
                    dividend: parseFloat(formData.dividend) || 0,
                    notes: formData.notes.trim(),
                    direction: formData.direction || 'long'
                };
                await saveTrades(tradesRef.current.map(t => t.id === editingTrade.id ? updatedTrade : t));
                setShowEditTrade(false);
                setEditingTrade(null);
                setFormData({ symbol: '', name: '', qty: '', entryPrice: '', entryDate: new Date().toISOString().split('T')[0],
                    exitDate: '', exitPrice: '', fees: '0', profit: '0', dividend: '0', notes: '', direction: 'long' });
            };

            const handleClearPortfolio = async () => {
                if (confirm('⚠️ Delete ALL trades? This cannot be undone!')) {
                    if (confirm('Last chance! Delete everything?')) {
                        await saveTrades([]);
                        setView('dashboard');
                    }
                }
            };

            const calculateMetrics = (tradesList) => {
                const openTrades = tradesList.filter(t => !t.exitDate);
                const closedTrades = tradesList.filter(t => t.exitDate);
                
                // Calculate realized profit (capital gains only from fully closed trades)
                const realizedProfit = closedTrades.reduce((sum, t) => sum + t.profit, 0);
                
                // Calculate profit from partial exits
                const partialExitProfit = tradesList.reduce((sum, t) => {
                    if (t.partialExits && t.partialExits.length > 0) {
                        return sum + t.partialExits.reduce((pSum, pe) => pSum + pe.profit, 0);
                    }
                    return sum;
                }, 0);
                
                // Total capital gains = fully closed + partial exits
                const totalCapitalGains = realizedProfit + partialExitProfit;
                
                // Total dividends
                const totalDividends = tradesList.reduce((sum, t) => sum + (t.dividend || 0), 0);
                
                // Total profit = capital gains + dividends
                const totalProfit = totalCapitalGains + totalDividends;
                
                const totalFees = tradesList.reduce((sum, t) => sum + t.fees, 0);
                const totalWins = closedTrades.filter(t => t.profit > 0).length;
                const totalLosses = closedTrades.filter(t => t.profit < 0).length;
                const winRate = totalWins + totalLosses > 0 ? (totalWins / (totalWins + totalLosses)) * 100 : 0;
                let unrealizedPL = 0;
                openTrades.forEach(trade => {
                    const currentPrice = manualPrices[trade.symbol] || currentPrices[trade.symbol] || trade.entryPrice;
                    const pl = (trade.direction === 'short'
                        ? (trade.entryPrice - currentPrice)
                        : (currentPrice - trade.entryPrice)) * trade.qty - trade.fees;
                    unrealizedPL += pl;
                });
                
                // Calculate today's P/L - sum of (currentPrice - prevClose) * qty for each open trade
                // This matches exactly what the Chg column shows per row
                let todaysPL = 0;
                openTrades.forEach(trade => {
                    const liveCurrentPrice = currentPrices[trade.symbol]; // live price only, no manual fallback
                    const prevClose = prevClosePrices[trade.symbol];
                    if (liveCurrentPrice && prevClose) {
                        todaysPL += (trade.direction === 'short'
                            ? (prevClose - liveCurrentPrice)
                            : (liveCurrentPrice - prevClose)) * trade.qty;
                    }
                });
                
                // Cost basis = total capital deployed in open positions
                const costBasis = openTrades.reduce((sum, t) => sum + (t.qty * t.entryPrice), 0);

                // Market value = current value of open positions
                const marketValue = openTrades.reduce((sum, trade) => {
                    const currentPrice = manualPrices[trade.symbol] || currentPrices[trade.symbol] || trade.entryPrice;
                    return sum + (trade.qty * currentPrice);
                }, 0);

                return { 
                    realizedProfit: totalCapitalGains,
                    totalProfit,
                    unrealizedPL, 
                    totalDividends, 
                    totalFees, 
                    winRate,
                    totalTrades: closedTrades.length, 
                    openPositions: openTrades.length, 
                    wins: totalWins, 
                    losses: totalLosses,
                    todaysPL,
                    costBasis,
                    marketValue
                };
            };

            const filterTradesByTimeframe = (tradesList) => {
                if (timeframe === 'ALL') return tradesList;
                const now = new Date(); const cutoff = new Date();
                switch (timeframe) {
                    case '1M': cutoff.setMonth(now.getMonth() - 1); break;
                    case '3M': cutoff.setMonth(now.getMonth() - 3); break;
                    case '6M': cutoff.setMonth(now.getMonth() - 6); break;
                    case '1Y': cutoff.setFullYear(now.getFullYear() - 1); break;
                    case 'YTD': cutoff.setMonth(0); cutoff.setDate(1); break;
                    default: return tradesList;
                }
                return tradesList.filter(t => new Date(t.entryDate) >= cutoff);
            };

            const filteredTrades = filterTradesByTimeframe(trades);
            const metrics = calculateMetrics(filteredTrades);
            
            const chartData = useMemo(() => {
                const now = new Date();
                const cutoff = new Date();
                switch (chartTimeframe) {
                    case '5D':  cutoff.setDate(now.getDate() - 5); break;
                    case '1M':  cutoff.setMonth(now.getMonth() - 1); break;
                    case '3M':  cutoff.setMonth(now.getMonth() - 3); break;
                    case '6M':  cutoff.setMonth(now.getMonth() - 6); break;
                    case 'YTD': cutoff.setMonth(0); cutoff.setDate(1); break;
                    case '1Y':  cutoff.setFullYear(now.getFullYear() - 1); break;
                    case '3Y':  cutoff.setFullYear(now.getFullYear() - 3); break;
                    default:    cutoff.setFullYear(2000); break;
                }
                const allClosed = trades
                    .filter(t => t.exitDate && t.profit !== undefined)
                    .sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate));
                if (allClosed.length === 0) return [];
                
                // Get trades within the timeframe
                const windowTrades = allClosed.filter(t => new Date(t.exitDate) >= cutoff);
                
                // Start from $0 for this timeframe
                let cumulative = 0;
                const points = [{ date: cutoff.toISOString().split('T')[0], profit: 0 }];
                
                windowTrades.forEach(trade => {
                    cumulative += (trade.profit || 0);
                    points.push({ date: trade.exitDate, profit: parseFloat(cumulative.toFixed(2)) });
                });
                
                return points;
            }, [trades, chartTimeframe]);

            const handleExportCSV = () => {
                const headers = ['Symbol','Name','Qty','Original Qty','Entry Price','Exit Price','Entry Date','Exit Date','Profit','Dividends','Fees','Notes','Partial Exits','Partial Adds','Direction'];
                const rows = trades.map(t => [
                    t.symbol,
                    `"${(t.name || '').replace(/"/g, '""')}"`,
                    t.qty,
                    t.originalQty || t.qty,
                    t.entryPrice,
                    t.exitPrice || '',
                    t.entryDate,
                    t.exitDate || '',
                    t.profit,
                    t.dividend || 0,
                    t.fees,
                    `"${(t.notes || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    t.partialExits && t.partialExits.length > 0 ? `"${JSON.stringify(t.partialExits).replace(/"/g, '""')}"` : '',
                    t.partialAdds && t.partialAdds.length > 0 ? `"${JSON.stringify(t.partialAdds).replace(/"/g, '""')}"` : '',
                    t.direction || 'long'
                ]);
                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleExportJSON = () => {
                const backup = {
                    version: 1,
                    exportedAt: new Date().toISOString(),
                    trades
                };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImportJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (!backup.trades || !Array.isArray(backup.trades)) {
                            alert('Invalid backup file — no trades found.');
                            return;
                        }
                        if (!window.confirm(`This will replace all ${trades.length} current trades with ${backup.trades.length} trades from the backup (exported ${new Date(backup.exportedAt).toLocaleDateString()}). Continue?`)) return;
                        await window.storage.set(`portfolio_trades_${activePortfolioId}`, JSON.stringify(backup.trades));
                        setTrades(backup.trades);
                        alert(`✅ Successfully restored ${backup.trades.length} trades.`);
                    } catch (err) {
                        alert('Failed to read backup file. Make sure it\'s a valid JSON backup.');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleSort = (column) => {
                if (sortColumn === column) {
                    // Toggle direction if clicking same column
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    // New column, default to ascending
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };

            const sortTrades = (tradesToSort) => {
                if (!sortColumn) return tradesToSort;
                
                return [...tradesToSort].sort((a, b) => {
                    let aVal, bVal;
                    
                    switch (sortColumn) {
                        case 'symbol':
                            aVal = a.symbol.toLowerCase();
                            bVal = b.symbol.toLowerCase();
                            break;
                        case 'name':
                            aVal = (a.name || '').toLowerCase();
                            bVal = (b.name || '').toLowerCase();
                            break;
                        case 'qty':
                            aVal = a.qty;
                            bVal = b.qty;
                            break;
                        case 'originalQty':
                            aVal = a.originalQty || a.qty;
                            bVal = b.originalQty || b.qty;
                            break;
                        case 'entryPrice':
                            aVal = a.entryPrice;
                            bVal = b.entryPrice;
                            break;
                        case 'exitPrice':
                            aVal = a.exitPrice || 0;
                            bVal = b.exitPrice || 0;
                            break;
                        case 'entryDate':
                            aVal = new Date(a.entryDate);
                            bVal = new Date(b.entryDate);
                            break;
                        case 'exitDate':
                            aVal = a.exitDate ? new Date(a.exitDate) : new Date('9999-12-31');
                            bVal = b.exitDate ? new Date(b.exitDate) : new Date('9999-12-31');
                            break;
                        case 'marketValue':
                            // For closed trades: qty * exitPrice
                            // For open trades: qty * currentPrice
                            aVal = a.exitDate ? (a.qty * (a.exitPrice || a.entryPrice)) : (a.qty * (manualPrices[a.symbol] || currentPrices[a.symbol] || a.entryPrice));
                            bVal = b.exitDate ? (b.qty * (b.exitPrice || b.entryPrice)) : (b.qty * (manualPrices[b.symbol] || currentPrices[b.symbol] || b.entryPrice));
                            break;
                        case 'profit':
                            aVal = a.profit;
                            bVal = b.profit;
                            break;
                        case 'totalProfit':
                            aVal = a.profit + (a.dividend || 0);
                            bVal = b.profit + (b.dividend || 0);
                            break;
                        case 'changePercent':
                            // For open trades: compare current price to entry
                            // For closed trades: compare exit price to entry
                            const aPrice = a.exitDate ? (a.exitPrice || a.entryPrice) : (manualPrices[a.symbol] || currentPrices[a.symbol] || a.entryPrice);
                            const bPrice = b.exitDate ? (b.exitPrice || b.entryPrice) : (manualPrices[b.symbol] || currentPrices[b.symbol] || b.entryPrice);
                            aVal = ((aPrice - a.entryPrice) / a.entryPrice) * 100;
                            bVal = ((bPrice - b.entryPrice) / b.entryPrice) * 100;
                            break;
                        case 'totalChg':
                            // Exit price - Entry price (for all trades)
                            const aTotalChgPrice = a.exitDate ? (a.exitPrice || a.entryPrice) : (manualPrices[a.symbol] || currentPrices[a.symbol] || a.entryPrice);
                            const bTotalChgPrice = b.exitDate ? (b.exitPrice || b.entryPrice) : (manualPrices[b.symbol] || currentPrices[b.symbol] || b.entryPrice);
                            aVal = a.direction === 'short' ? a.entryPrice - aTotalChgPrice : aTotalChgPrice - a.entryPrice;
                            bVal = b.direction === 'short' ? b.entryPrice - bTotalChgPrice : bTotalChgPrice - b.entryPrice;
                            break;
                        case 'chg':
                            // Current day change (only for open trades, 0 for closed)
                            const aCurr = manualPrices[a.symbol] || currentPrices[a.symbol] || 0;
                            const bCurr = manualPrices[b.symbol] || currentPrices[b.symbol] || 0;
                            aVal = a.exitDate ? 0 : (a.direction === 'short' ? (prevClosePrices[a.symbol] || aCurr) - aCurr : aCurr - (prevClosePrices[a.symbol] || aCurr));
                            bVal = b.exitDate ? 0 : (b.direction === 'short' ? (prevClosePrices[b.symbol] || bCurr) - bCurr : bCurr - (prevClosePrices[b.symbol] || bCurr));
                            break;
                        case 'todaysProfit':
                            // Today's profit = direction-adjusted (current - prevClose) * qty
                            const aCurrPrice = manualPrices[a.symbol] || currentPrices[a.symbol] || 0;
                            const bCurrPrice = manualPrices[b.symbol] || currentPrices[b.symbol] || 0;
                            const aDayChg = a.exitDate ? 0 : (a.direction === 'short' ? (prevClosePrices[a.symbol] || aCurrPrice) - aCurrPrice : aCurrPrice - (prevClosePrices[a.symbol] || aCurrPrice));
                            const bDayChg = b.exitDate ? 0 : (b.direction === 'short' ? (prevClosePrices[b.symbol] || bCurrPrice) - bCurrPrice : bCurrPrice - (prevClosePrices[b.symbol] || bCurrPrice));
                            aVal = aDayChg * a.qty;
                            bVal = bDayChg * b.qty;
                            break;
                        default:
                            return 0;
                    }
                    
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            let displayTrades = filteredTrades;
            if (tradeView === 'open') displayTrades = filteredTrades.filter(t => !t.exitDate);
            if (tradeView === 'closed') displayTrades = filteredTrades.filter(t => t.exitDate);

            // Apply search filter
            if (searchTerm.trim()) {
                displayTrades = displayTrades.filter(t => 
                    t.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (t.name && t.name.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }

            // Apply sorting
            displayTrades = sortTrades(displayTrades);

            // Only show split columns (Orig Qty / Remaining) if we're showing open trades AND any have partial exits
            const showSplitQtyColumns = tradeView !== 'closed' && displayTrades.some(t => !t.exitDate && ((t.partialExits || []).length > 0 || (t.partialAdds || []).length > 0));
            
            // Only show Chg column (intraday change) when viewing open trades
            const showChgColumn = tradeView !== 'closed';

            if (isLoading) {
                return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', background: T.pageBg, color: T.textPrimary }}>
                    <div style={{ fontSize: '1.2rem' }}>Loading...</div>
                </div>;
            }

            if (view === 'dashboard') {
                return (
                    <div style={{ minHeight: '100vh', padding: '2rem', background: T.pageBg, color: T.textPrimary }}>
                        <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
                            <div style={{ display: 'flex', alignItems: 'center', marginBottom: '3rem' }}>
                            <div style={{ flex: 1 }} />
                            <div style={{ textAlign: 'center' }}>
                                <h1 style={{ fontSize: '2.5rem', fontWeight: '800', margin: 0 }}>
                                    PORTFOLIO TRACKER
                                </h1>
                                {portfolios.length > 1 && (
                                    <div style={{ fontSize: '0.85rem', color: T.textMuted, marginTop: '0.3rem', fontWeight: '600', letterSpacing: '0.05em', textTransform: 'uppercase' }}>
                                        {portfolios.find(p => p.id === activePortfolioId)?.name || ''}
                                    </div>
                                )}
                            </div>
                            <div style={{ flex: 1, display: 'flex', justifyContent: 'flex-end', alignItems: 'center' }}>
                                <button onClick={toggleTheme} title={isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                                    style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 0, display: 'flex', alignItems: 'center' }}>
                                    <span style={{
                                        display: 'inline-flex', alignItems: 'center', gap: '6px',
                                        background: T.panelBg, border: `1px solid ${T.borderStrong}`,
                                        borderRadius: '999px', padding: '5px 6px 5px 10px',
                                        boxShadow: isDark ? 'none' : '0 1px 4px rgba(0,0,0,0.10)'
                                    }}>
                                        <span style={{ fontSize: '0.7rem', fontWeight: '700', letterSpacing: '0.05em', color: T.textMuted, userSelect: 'none', fontFamily: 'inherit' }}>
                                            {isDark ? 'DARK' : 'LIGHT'}
                                        </span>
                                        <span style={{
                                            width: '32px', height: '18px', borderRadius: '999px', position: 'relative', flexShrink: 0,
                                            background: isDark ? '#1a1a2e' : '#e0eaff',
                                            border: `1px solid ${isDark ? '#333' : '#b8ccf0'}`,
                                            transition: 'background 0.3s, border-color 0.3s',
                                            display: 'inline-block'
                                        }}>
                                            <span style={{
                                                position: 'absolute', top: '2px',
                                                left: isDark ? '2px' : '14px',
                                                width: '12px', height: '12px', borderRadius: '50%',
                                                background: isDark ? '#555' : '#4f8ef7',
                                                transition: 'left 0.25s cubic-bezier(0.4,0,0.2,1), background 0.3s',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                boxShadow: isDark ? 'none' : '0 1px 3px rgba(79,142,247,0.5)'
                                            }}>
                                                {isDark
                                                    ? <svg width="8" height="8" viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#bbb"/></svg>
                                                    : <svg width="8" height="8" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="5" fill="white"/><line x1="12" y1="1" x2="12" y2="3" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="12" y1="21" x2="12" y2="23" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="1" y1="12" x2="3" y2="12" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="21" y1="12" x2="23" y2="12" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="white" strokeWidth="2.5" strokeLinecap="round"/></svg>
                                                }
                                            </span>
                                        </span>
                                    </span>
                                </button>
                            </div>
                            </div>

                            {/* Portfolio switcher tabs */}
                            {portfolios.length > 1 && (
                                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '2rem', flexWrap: 'wrap', alignItems: 'center', borderBottom: `2px solid ${T.border}`, paddingBottom: '0' }}>
                                    {portfolios.map(p => {
                                        const isActive = activePortfolioId === p.id;
                                        return (
                                            <div key={p.id} style={{ display: 'flex', alignItems: 'stretch', marginBottom: '-2px' }}>
                                                <button
                                                    onClick={() => handleSwitchPortfolio(p.id)}
                                                    style={{
                                                        padding: '0.6rem 1.2rem',
                                                        borderRadius: '6px 0 0 0',
                                                        border: `1px solid ${isActive ? T.borderStrong : 'transparent'}`,
                                                        borderBottom: isActive ? `2px solid ${T.panelBg}` : '2px solid transparent',
                                                        background: isActive ? T.panelBg : 'transparent',
                                                        color: isActive ? T.textPrimary : T.textMuted,
                                                        fontWeight: isActive ? '700' : '500',
                                                        fontSize: '0.9rem', cursor: 'pointer',
                                                        letterSpacing: '0.01em',
                                                    }}
                                                >{p.name}</button>
                                                <button
                                                    onClick={() => handleDeletePortfolio(p.id)}
                                                    title="Delete portfolio"
                                                    style={{
                                                        padding: '0.6rem 0.5rem',
                                                        borderRadius: '0 6px 0 0',
                                                        border: `1px solid ${isActive ? T.borderStrong : 'transparent'}`,
                                                        borderLeft: 'none',
                                                        borderBottom: isActive ? `2px solid ${T.panelBg}` : '2px solid transparent',
                                                        background: isActive ? T.panelBg : 'transparent',
                                                        color: isActive ? T.textMuted : T.textFaint,
                                                        fontSize: '0.7rem', cursor: 'pointer', lineHeight: 1,
                                                    }}
                                                >✕</button>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {trades.length === 0 ? (
                                <div style={{ textAlign: 'center', padding: '4rem 2rem', background: T.panelBg, borderRadius: '8px', border: `1px solid ${T.border}` }}>
                                    <div style={{ fontSize: '1.5rem', fontWeight: '700', marginBottom: '1rem' }}>No trades yet</div>
                                    <div style={{ fontSize: '1rem', color: T.textMuted, marginBottom: '2rem' }}>Upload a CSV or add your first trade manually</div>
                                    <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap' }}>
                                        <button onClick={() => setShowAddTrade(true)} style={{ background: T.raisedBg, color: T.textPrimary, border: `1px solid ${T.borderStrong}`, padding: '1rem 2rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '1rem', display: 'inline-flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <Plus size={20} /> Add Trade
                                        </button>
                                        <button onClick={() => setShowCSVUpload(true)} style={{ background: T.raisedBg, color: T.blue, border: `1px solid ${T.borderStrong}`, padding: '1rem 2rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '1rem', display: 'inline-flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <Upload size={20} /> Upload CSV
                                        </button>
                                        <label style={{ background: T.raisedBg, color: T.amber, border: `1px solid ${T.borderStrong}`, padding: '1rem 2rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '1rem', display: 'inline-flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <Upload size={20} /> Restore JSON
                                            <input type="file" accept=".json" onChange={handleImportJSON} style={{ display: 'none' }} />
                                        </label>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Today's P/L</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700', color: metrics.todaysPL >= 0 ? T.green : T.red }}>
                                                {metrics.todaysPL >= 0 ? '+' : ''}${metrics.todaysPL.toFixed(2)}
                                            </div>
                                            <div style={{ fontSize: '0.75rem', color: T.textMuted, marginTop: '0.5rem' }}>
                                                Intraday Movement
                                            </div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Realized Profit</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700', color: metrics.realizedProfit >= 0 ? T.green : T.red }}>
                                                ${metrics.realizedProfit.toFixed(2)}
                                            </div>
                                            <div style={{ fontSize: '0.75rem', color: T.textMuted, marginTop: '0.5rem' }}>Capital Gains Only</div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Total Profit</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700', color: metrics.totalProfit >= 0 ? T.green : T.red }}>
                                                ${metrics.totalProfit.toFixed(2)}
                                            </div>
                                            <div style={{ fontSize: '0.75rem', color: T.textMuted, marginTop: '0.5rem' }}>Incl. ${metrics.totalDividends.toFixed(2)} Dividends</div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Unrealized P/L</div>
                                                <button onClick={fetchCurrentPrices} disabled={fetchingPrices} title="Refresh live prices" style={{ background: 'transparent', border: 'none', color: fetchingPrices ? T.textFaint : T.blue, cursor: fetchingPrices ? 'not-allowed' : 'pointer', fontSize: '0.85rem', padding: 0 }}>
                                                    {fetchingPrices ? '⟳' : '↻'}
                                                </button>
                                            </div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700', color: metrics.unrealizedPL >= 0 ? T.green : T.red }}>
                                                {metrics.unrealizedPL >= 0 ? '+' : ''}${metrics.unrealizedPL.toFixed(2)}
                                            </div>
                                            <div style={{ fontSize: '0.7rem', color: T.textFaint, marginTop: '0.25rem' }}>
                                                {fetchingPrices ? 'Fetching live prices...' : 'Click ↻ to refresh'}
                                            </div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Total Dividends</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700', color: T.blue }}>${metrics.totalDividends.toFixed(2)}</div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Win Rate</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700' }}>{metrics.winRate.toFixed(1)}%</div>
                                            <div style={{ fontSize: '0.75rem', color: T.textMuted, marginTop: '0.25rem' }}>{metrics.wins}W / {metrics.losses}L</div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Total Trades</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700' }}>{metrics.totalTrades}</div>
                                            <div style={{ fontSize: '0.75rem', color: T.textMuted, marginTop: '0.25rem' }}>{metrics.openPositions} open</div>
                                        </div>
                                        <div style={{ background: T.panelBg, borderRadius: '8px', padding: '1.5rem', border: `1px solid ${T.border}` }}>
                                            <div style={{ fontSize: '0.85rem', color: T.textMuted, marginBottom: '0.5rem', textTransform: 'uppercase', fontWeight: '600' }}>Total Fees</div>
                                            <div style={{ fontSize: '2rem', fontWeight: '700', color: T.red }}>${metrics.totalFees.toFixed(2)}</div>
                                        </div>
                                    </div>

                                    {(() => {
                                        const ChartComponent = () => {
                                            const canvasRef = React.useRef(null);
                                            const chartRef = React.useRef(null);
                                            
                                            React.useEffect(() => {
                                                if (!canvasRef.current || !window.Chart || chartData.length < 2) return;
                                                
                                                // Destroy previous chart if it exists
                                                if (chartRef.current) {
                                                    chartRef.current.destroy();
                                                }
                                                
                                                const ctx = canvasRef.current.getContext('2d');
                                                chartRef.current = new window.Chart(ctx, {
                                                    type: 'line',
                                                    data: {
                                                        labels: chartData.map(d => d.date),
                                                        datasets: [{
                                                            label: 'Cumulative Profit',
                                                            data: chartData.map(d => d.profit),
                                                            borderColor: T.green,
                                                            backgroundColor: T.greenBg,
                                                            borderWidth: 2,
                                                            pointRadius: chartData.length <= 50 ? 3 : 0,
                                                            pointBackgroundColor: T.green,
                                                            pointHoverRadius: 5,
                                                            tension: 0.1,
                                                            fill: true
                                                        }]
                                                    },
                                                    options: {
                                                        responsive: true,
                                                        maintainAspectRatio: false,
                                                        plugins: {
                                                            legend: { display: false },
                                                            tooltip: {
                                                                backgroundColor: T.surfaceBg,
                                                                borderColor: T.borderStrong,
                                                                borderWidth: 1,
                                                                titleColor: T.textSecondary,
                                                                bodyColor: T.textPrimary,
                                                                callbacks: {
                                                                    label: (context) => `$${context.parsed.y.toFixed(2)}`
                                                                }
                                                            }
                                                        },
                                                        scales: {
                                                            x: {
                                                                grid: { color: T.raisedBg, drawBorder: false },
                                                                ticks: { color: T.textFaint, font: { size: 10 } }
                                                            },
                                                            y: {
                                                                grid: { color: T.raisedBg, drawBorder: false },
                                                                ticks: { 
                                                                    color: T.textFaint, 
                                                                    font: { size: 10 },
                                                                    callback: (value) => `$${value >= 1000 ? (value/1000).toFixed(1)+'k' : value.toFixed(0)}`
                                                                }
                                                            }
                                                        }
                                                    }
                                                });
                                                
                                                return () => {
                                                    if (chartRef.current) {
                                                        chartRef.current.destroy();
                                                    }
                                                };
                                            }, [chartData, isDark]);
                                            
                                            return (
                                                <div style={{ background: T.panelBg, borderRadius: '8px', padding: '2rem', border: `1px solid ${T.border}`, marginBottom: '2rem' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                                                        <h3 style={{ fontSize: '1.2rem', fontWeight: '700', margin: 0 }}>Cumulative Profit Over Time</h3>
                                                        <div style={{ display: 'flex', gap: '0.4rem', flexWrap: 'wrap' }}>
                                                            {['5D','1M','3M','6M','YTD','1Y','3Y','ALL'].map(tf => (
                                                                <button key={tf} onClick={() => setChartTimeframe(tf)} style={{
                                                                    background: chartTimeframe === tf ? T.green : 'transparent',
                                                                    color: chartTimeframe === tf ? T.pageBg : T.textMuted,
                                                                    border: `1px solid ${chartTimeframe === tf ? T.green : T.borderStrong}`,
                                                                    padding: '0.3rem 0.65rem', borderRadius: '4px', cursor: 'pointer',
                                                                    fontWeight: '600', fontSize: '0.75rem'
                                                                }}>{tf}</button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    {chartData.length < 2 ? (
                                                        <div style={{ height: '300px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: T.textFaint, fontSize: '0.9rem' }}>
                                                            No closed trades in this timeframe
                                                        </div>
                                                    ) : (
                                                        <div style={{ height: '300px', position: 'relative' }}>
                                                            <canvas ref={canvasRef}></canvas>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        };
                                        
                                        if (!window.Chart) return (
                                            <div style={{ background: T.panelBg, borderRadius: '8px', padding: '2rem', border: `1px solid ${T.border}`, marginBottom: '2rem', textAlign: 'center', color: T.textMuted }}>
                                                Chart library not loaded. Try refreshing the page.
                                            </div>
                                        );
                                        
                                        return <ChartComponent />;
                                    })()}

                                    <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap', alignItems: 'center' }}>
                                        <button onClick={() => setView('trades')} style={{ background: T.green, color: T.pageBg, border: 'none', padding: '1rem 2rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '1rem' }}>View All Trades</button>
                                        <button onClick={() => setShowAddTrade(true)} style={{ background: T.raisedBg, color: T.textPrimary, border: `1px solid ${T.borderStrong}`, padding: '1rem 2rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '1rem' }}>Add Trade</button>
                                        
                                        {/* Settings Menu */}
                                        <div style={{ position: 'relative' }}>
                                            <button 
                                                onClick={() => setShowSettingsMenu(!showSettingsMenu)}
                                                style={{ 
                                                    background: T.raisedBg, 
                                                    color: T.textMuted, 
                                                    border: `1px solid ${T.borderStrong}`, 
                                                    padding: '1rem', 
                                                    borderRadius: '4px', 
                                                    cursor: 'pointer', 
                                                    fontWeight: '600', 
                                                    fontSize: '1rem',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '0.5rem'
                                                }}
                                            >
                                                <Settings size={20} />
                                            </button>
                                            
                                            {showSettingsMenu && (
                                                <>
                                                    {/* Backdrop to close menu */}
                                                    <div 
                                                        onClick={() => setShowSettingsMenu(false)}
                                                        style={{ 
                                                            position: 'fixed', 
                                                            top: 0, 
                                                            left: 0, 
                                                            right: 0, 
                                                            bottom: 0, 
                                                            zIndex: 999 
                                                        }}
                                                    />
                                                    
                                                    {/* Dropdown Menu */}
                                                    <div style={{ 
                                                        position: 'absolute', 
                                                        top: 'calc(100% + 0.5rem)', 
                                                        right: 0, 
                                                        background: T.panelBg, 
                                                        border: `1px solid ${T.borderStrong}`, 
                                                        borderRadius: '8px', 
                                                        padding: '0.5rem',
                                                        minWidth: '220px',
                                                        boxShadow: T.shadowLg,
                                                        zIndex: 1000
                                                    }}>
                                                        <button
                                                            onClick={() => { setShowAddPortfolio(true); setShowSettingsMenu(false); }}
                                                            style={{ 
                                                                width: '100%',
                                                                background: 'transparent', 
                                                                color: T.green, 
                                                                border: 'none', 
                                                                padding: '0.75rem 1rem', 
                                                                borderRadius: '4px', 
                                                                cursor: 'pointer', 
                                                                fontWeight: '600', 
                                                                fontSize: '0.9rem',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                textAlign: 'left',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.currentTarget.style.background = T.hoverBg}
                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                        >
                                                            <Plus size={18} /> Add Portfolio
                                                        </button>

                                                        <div style={{ height: '1px', background: T.borderMid, margin: '0.5rem 0' }} />

                                                        <label 
                                                            style={{ 
                                                                width: '100%',
                                                                background: 'transparent', 
                                                                color: T.blue, 
                                                                border: 'none', 
                                                                padding: '0.75rem 1rem', 
                                                                borderRadius: '4px', 
                                                                cursor: 'pointer', 
                                                                fontWeight: '600', 
                                                                fontSize: '0.9rem',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.currentTarget.style.background = T.hoverBg}
                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                            onClick={() => setShowSettingsMenu(false)}
                                                        >
                                                            <Upload size={18} /> Upload CSV
                                                            <input type="file" accept=".csv" onChange={(e) => { handleCSVUpload(e); setShowSettingsMenu(false); }} style={{ display: 'none' }} />
                                                        </label>

                                                        <div style={{ height: '1px', background: T.borderMid, margin: '0.5rem 0' }} />
                                                        <button
                                                            onClick={() => { handleExportCSV(); setShowSettingsMenu(false); }}
                                                            style={{ 
                                                                width: '100%',
                                                                background: 'transparent', 
                                                                color: T.green, 
                                                                border: 'none', 
                                                                padding: '0.75rem 1rem', 
                                                                borderRadius: '4px', 
                                                                cursor: 'pointer', 
                                                                fontWeight: '600', 
                                                                fontSize: '0.9rem',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                textAlign: 'left',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.currentTarget.style.background = T.hoverBg}
                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                        >
                                                            <Download size={18} /> Export CSV
                                                        </button>
                                                        
                                                        <div style={{ height: '1px', background: T.borderMid, margin: '0.5rem 0' }} />
                                                        
                                                        <button 
                                                            onClick={() => { handleExportJSON(); setShowSettingsMenu(false); }}
                                                            style={{ 
                                                                width: '100%',
                                                                background: 'transparent', 
                                                                color: T.amber, 
                                                                border: 'none', 
                                                                padding: '0.75rem 1rem', 
                                                                borderRadius: '4px', 
                                                                cursor: 'pointer', 
                                                                fontWeight: '600', 
                                                                fontSize: '0.9rem',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                textAlign: 'left',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.currentTarget.style.background = T.hoverBg}
                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                        >
                                                            <Download size={18} /> Backup JSON
                                                        </button>
                                                        
                                                        <label 
                                                            style={{ 
                                                                width: '100%',
                                                                background: 'transparent', 
                                                                color: T.amber, 
                                                                border: 'none', 
                                                                padding: '0.75rem 1rem', 
                                                                borderRadius: '4px', 
                                                                cursor: 'pointer', 
                                                                fontWeight: '600', 
                                                                fontSize: '0.9rem',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.currentTarget.style.background = T.hoverBg}
                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                        >
                                                            <Upload size={18} /> Restore JSON
                                                            <input type="file" accept=".json" onChange={(e) => { handleImportJSON(e); setShowSettingsMenu(false); }} style={{ display: 'none' }} />
                                                        </label>
                                                        
                                                        <div style={{ height: '1px', background: T.borderMid, margin: '0.5rem 0' }} />
                                                        
                                                        <button 
                                                            onClick={() => { handleClearPortfolio(); setShowSettingsMenu(false); }}
                                                            style={{ 
                                                                width: '100%',
                                                                background: 'transparent', 
                                                                color: T.red, 
                                                                border: 'none', 
                                                                padding: '0.75rem 1rem', 
                                                                borderRadius: '4px', 
                                                                cursor: 'pointer', 
                                                                fontWeight: '600', 
                                                                fontSize: '0.9rem',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                gap: '0.75rem',
                                                                textAlign: 'left',
                                                                transition: 'background 0.2s'
                                                            }}
                                                            onMouseEnter={(e) => e.currentTarget.style.background = T.hoverBg}
                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                        >
                                                            <Trash2 size={18} /> Clear Portfolio
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {showAddTrade && (
                            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1000 }}>
                                <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '540px', width: '100%', border: `1px solid ${T.border}`, maxHeight: '90vh', overflow: 'auto' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '2rem' }}>
                                        <h3 style={{ margin: 0, fontSize: '1.5rem' }}>ADD TRADE</h3>
                                        <button onClick={() => setShowAddTrade(false)} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                    </div>

                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem' }}>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Symbol *</label>
                                            <input type="text" placeholder="AAPL" value={formData.symbol}
                                                onChange={(e) => setFormData({...formData, symbol: e.target.value.toUpperCase()})}
                                                onBlur={async (e) => {
                                                    const sym = e.target.value.trim();
                                                    if (!sym) return;
                                                    if (formData.name && formData.name.trim()) return;
                                                    setFetchingName(true);
                                                    const name = await fetchSymbolName(sym);
                                                    setFetchingName(false);
                                                    if (name) setFormData(prev => ({ ...prev, name }));
                                                }}
                                                style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.95rem' }} /></div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600', whiteSpace: 'nowrap' }}>Direction</label>
                                            <select value={formData.direction} onChange={(e) => setFormData({...formData, direction: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: formData.direction === 'short' ? T.red : T.green, fontWeight: '600', cursor: 'pointer', fontSize: '0.9rem' }}>
                                                <option value="long" style={{ color: T.green }}>Long</option>
                                                <option value="short" style={{ color: T.red }}>Short</option>
                                            </select></div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600', whiteSpace: 'nowrap' }}>Qty *</label>
                                            <input type="number" placeholder="100" value={formData.qty} onChange={(e) => setFormData({...formData, qty: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.95rem' }} /></div>
                                        </div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Name {fetchingName && <span style={{ color: T.textFaint, fontWeight: 400, fontSize: '0.75rem', marginLeft: '0.5rem' }}>⟳ looking up...</span>}</label>
                                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <input type="text" placeholder={fetchingName ? 'Fetching name...' : 'Auto-filled from symbol, or type manually'} value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={{ flex: 1, padding: '0.75rem', background: T.panelBg, border: `1px solid ${fetchingName ? T.textFaint : T.borderMid}`, borderRadius: '4px', color: T.textPrimary, transition: 'border-color 0.2s' }} />
                                        <button type="button" title="Lookup name from symbol" onClick={async () => { if (!formData.symbol) return; setFetchingName(true); const name = await fetchSymbolName(formData.symbol); setFetchingName(false); if (name) setFormData(prev => ({ ...prev, name })); else alert('Could not find name for "' + formData.symbol + '". Try entering it manually.'); }} style={{ padding: '0.75rem 0.9rem', background: T.raisedBg, border: `1px solid ${T.borderStrong}`, borderRadius: '4px', color: formData.symbol ? T.textSecondary : T.textFaint, cursor: formData.symbol ? 'pointer' : 'not-allowed', fontSize: '0.9rem' }}>🔍</button>
                                        </div></div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Entry Price *</label>
                                            <input type="number" step="0.01" placeholder="150.25" value={formData.entryPrice} onChange={(e) => setFormData({...formData, entryPrice: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Entry Date *</label>
                                            <input type="date" value={formData.entryDate} onChange={(e) => setFormData({...formData, entryDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Price</label>
                                            <input type="number" step="0.01" placeholder="160.50" value={formData.exitPrice} onChange={(e) => { const newExitPrice = e.target.value; setFormData({...formData, exitPrice: newExitPrice, exitDate: newExitPrice && !formData.exitDate ? new Date().toISOString().split("T")[0] : formData.exitDate}); }} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Date</label>
                                            <input type="date" value={formData.exitDate} onChange={(e) => setFormData({...formData, exitDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 72px', gap: '1rem' }}>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Profit</label>
                                            <input type="number" step="0.01" value={formData.profit} onChange={(e) => setFormData({...formData, profit: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Dividends</label>
                                            <input type="number" step="0.01" value={formData.dividend} onChange={(e) => setFormData({...formData, dividend: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} />
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem', marginTop: '0.35rem' }}>
                                                {dividendAddActive ? (
                                                    <>
                                                        <input autoFocus type="number" step="0.01" placeholder="add amount" value={dividendAddVal} onChange={(e) => setDividendAddVal(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && dividendAddVal) { setFormData(prev => ({...prev, dividend: String(((parseFloat(prev.dividend) || 0) + parseFloat(dividendAddVal)).toFixed(2))})); setDividendAddVal(''); setDividendAddActive(false); } else if (e.key === 'Escape') { setDividendAddVal(''); setDividendAddActive(false); } }} style={{ flex: 1, padding: '0.28rem 0.45rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '3px', color: T.textPrimary, fontSize: '0.72rem' }} />
                                                        <button onClick={() => { if (dividendAddVal) { setFormData(prev => ({...prev, dividend: String(((parseFloat(prev.dividend) || 0) + parseFloat(dividendAddVal)).toFixed(2))})); } setDividendAddVal(''); setDividendAddActive(false); }} style={{ padding: '0.28rem 0.5rem', background: 'transparent', border: `1px solid ${T.green}`, borderRadius: '3px', color: T.green, cursor: 'pointer', fontSize: '0.72rem', lineHeight: 1 }}>&#10003;</button>
                                                        <button onClick={() => { setDividendAddVal(''); setDividendAddActive(false); }} style={{ padding: '0.28rem 0.45rem', background: 'transparent', border: `1px solid ${T.textFaint}`, borderRadius: '3px', color: T.textMuted, cursor: 'pointer', fontSize: '0.72rem', lineHeight: 1 }}>&#10005;</button>
                                                    </>
                                                ) : (
                                                    <button onClick={() => setDividendAddActive(true)} title="Add to dividend total" style={{ padding: '0.18rem 0.45rem', background: 'transparent', border: `1px solid ${T.textFaint}`, borderRadius: '3px', color: T.textMuted, cursor: 'pointer', fontSize: '0.68rem', display: 'flex', alignItems: 'center', gap: '0.2rem', lineHeight: 1 }}>
                                                        <span style={{ fontSize: '0.8rem', lineHeight: 1 }}>+</span> add
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Fees</label>
                                            <input type="number" step="0.01" value={formData.fees} onChange={(e) => setFormData({...formData, fees: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        </div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Notes</label>
                                        <textarea placeholder="Trade notes..." value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, minHeight: '80px', fontFamily: 'inherit' }} /></div>
                                        <button onClick={handleAddTrade} disabled={!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate} style={{ background: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? T.borderStrong : T.green, color: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? T.textMuted : T.pageBg, border: 'none', padding: '1rem', borderRadius: '4px', cursor: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? 'not-allowed' : 'pointer', fontWeight: '600', marginTop: '1rem' }}>ADD TRADE</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showAddPortfolio && (
                            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1000 }}>
                                <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '420px', width: '100%', border: `1px solid ${T.border}` }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                        <h3 style={{ margin: 0, fontSize: '1.25rem', fontWeight: '700' }}>NEW PORTFOLIO</h3>
                                        <button onClick={() => { setShowAddPortfolio(false); setNewPortfolioName(''); }} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                    </div>
                                    <div style={{ marginBottom: '1rem', color: T.textMuted, fontSize: '0.9rem' }}>
                                        Create a separate portfolio to track different accounts (e.g. TFSA, RRSP, Margin).
                                    </div>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Portfolio Name</label>
                                    <input
                                        type="text"
                                        placeholder="e.g. TFSA, RRSP, Margin..."
                                        value={newPortfolioName}
                                        onChange={(e) => setNewPortfolioName(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleAddPortfolio()}
                                        autoFocus
                                        style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '1rem', marginBottom: '1.25rem', boxSizing: 'border-box' }}
                                    />
                                    <button
                                        onClick={handleAddPortfolio}
                                        disabled={!newPortfolioName.trim()}
                                        style={{ width: '100%', background: newPortfolioName.trim() ? T.green : T.borderStrong, color: newPortfolioName.trim() ? T.pageBg : T.textMuted, border: 'none', padding: '0.85rem', borderRadius: '4px', cursor: newPortfolioName.trim() ? 'pointer' : 'not-allowed', fontWeight: '700', fontSize: '1rem' }}
                                    >CREATE PORTFOLIO</button>
                                </div>
                            </div>
                        )}

                        {showCSVUpload && (
                            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1000 }}>
                                <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '600px', width: '100%', border: `1px solid ${T.border}` }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '2rem' }}>
                                        <h3 style={{ margin: 0, fontSize: '1.5rem' }}>UPLOAD CSV</h3>
                                        <button onClick={() => setShowCSVUpload(false)} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                    </div>
                                    <div style={{ marginBottom: '1.5rem', color: T.textSecondary, fontSize: '0.9rem', lineHeight: '1.6' }}>
                                        <strong style={{ color: T.green }}>Expected CSV format:</strong><br/><br/>
                                        <strong>Required:</strong> Symbol, Qty, Entry Price, Entry Date<br/>
                                        <strong>Optional:</strong> Name, Exit Date, Fees, Total Profit, Log
                                    </div>
                                    <label style={{ display: 'block', padding: '3rem', border: `2px dashed ${T.borderStrong}`, borderRadius: '8px', textAlign: 'center', cursor: processingCSV ? 'not-allowed' : 'pointer' }}>
                                        <input type="file" accept=".csv" onChange={handleCSVUpload} disabled={processingCSV} style={{ display: 'none' }} />
                                        <Upload size={48} style={{ margin: '0 auto 1rem', display: 'block', color: T.blue }} />
                                        <div style={{ fontSize: '1.1rem', fontWeight: '600', marginBottom: '0.5rem' }}>
                                            {processingCSV ? 'Processing...' : 'Click to upload CSV'}
                                        </div>
                                    </label>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // Trades View - CONTINUED IN PART 2 due to length
            return (
                <div style={{ minHeight: '100vh', padding: '2rem', background: T.pageBg, color: T.textPrimary }}>
                    <div style={{ maxWidth: '1600px', margin: '0 auto' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <button onClick={() => setView('dashboard')} style={{ background: 'transparent', border: `1px solid ${T.borderStrong}`, color: T.textMuted, padding: '0.5rem', borderRadius: '4px', cursor: 'pointer', display: 'flex', alignItems: 'center' }}><Home size={24} /></button>
                                <h1 style={{ fontSize: '2rem', fontWeight: '800', margin: 0 }}>
                                    {tradeView === 'all' ? 'ALL TRADES' : tradeView === 'open' ? 'OPEN TRADES' : 'CLOSED TRADES'}
                                </h1>
                            </div>
                            <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                                <button onClick={() => setShowAddTrade(true)} style={{ background: T.green, color: T.pageBg, border: 'none', padding: '0.75rem 1.5rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Plus size={20} /> Add Trade</button>
                                <div style={{ position: 'relative' }}>
                                    <button onClick={() => setShowDataMenu(v => !v)} style={{ background: showDataMenu ? T.borderMid : T.raisedBg, border: `1px solid ${T.borderStrong}`, color: T.textPrimary, padding: '0.75rem 1.1rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '1rem' }}>▾</button>
                                    {showDataMenu && (
                                        <div style={{ position: 'absolute', right: 0, top: 'calc(100% + 6px)', background: T.surfaceBg, border: `1px solid ${T.borderStrong}`, borderRadius: '6px', zIndex: 200, minWidth: '180px', overflow: 'hidden', boxShadow: T.shadowMd }} onMouseLeave={() => setShowDataMenu(false)}>
                                            <button onClick={() => { setShowCSVUpload(true); setShowDataMenu(false); }} style={{ width: '100%', background: 'transparent', border: 'none', borderBottom: `1px solid ${T.border}`, color: T.blue, padding: '0.75rem 1rem', cursor: 'pointer', fontWeight: '600', fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
                                                <Upload size={15} /> Upload CSV
                                            </button>
                                            <button onClick={() => { handleExportCSV(); setShowDataMenu(false); }} style={{ width: '100%', background: 'transparent', border: 'none', borderBottom: `1px solid ${T.border}`, color: T.green, padding: '0.75rem 1rem', cursor: 'pointer', fontWeight: '600', fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
                                                <Download size={15} /> Export CSV
                                            </button>
                                            <button onClick={() => { handleExportJSON(); setShowDataMenu(false); }} style={{ width: '100%', background: 'transparent', border: 'none', borderBottom: `1px solid ${T.border}`, color: T.amber, padding: '0.75rem 1rem', cursor: 'pointer', fontWeight: '600', fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '0.6rem' }}>
                                                <Download size={15} /> Backup JSON
                                            </button>
                                            <label style={{ width: '100%', background: 'transparent', border: 'none', color: T.amber, padding: '0.75rem 1rem', cursor: 'pointer', fontWeight: '600', fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '0.6rem', boxSizing: 'border-box' }}>
                                                <Upload size={15} /> Restore JSON
                                                <input type="file" accept=".json" onChange={(e) => { handleImportJSON(e); setShowDataMenu(false); }} style={{ display: 'none' }} />
                                            </label>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'space-between' }}>
                            <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                <input 
                                    type="text" 
                                    placeholder="Search symbol or name..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    style={{ 
                                        padding: '0.5rem 1rem', 
                                        background: T.panelBg, 
                                        border: `1px solid ${T.borderStrong}`, 
                                        borderRadius: '4px', 
                                        color: T.textPrimary, 
                                        fontSize: '0.85rem',
                                        width: '250px'
                                    }}
                                />
                                {tradeView === 'open' && (
                                    <button 
                                        onClick={fetchCurrentPrices} 
                                        disabled={fetchingPrices}
                                        title="Refresh live prices"
                                        style={{ 
                                            background: 'transparent', 
                                            border: `1px solid ${T.borderStrong}`, 
                                            color: fetchingPrices ? T.textFaint : T.blue, 
                                            padding: '0.5rem 0.75rem', 
                                            borderRadius: '4px', 
                                            cursor: fetchingPrices ? 'not-allowed' : 'pointer', 
                                            fontSize: '0.9rem',
                                            fontWeight: '600'
                                        }}
                                    >
                                        {fetchingPrices ? '⟳' : '↻'}
                                    </button>
                                )}
                            </div>
                            
                            {tradeView === 'open' && (
                                <div style={{ display: 'flex', gap: '1.5rem', alignItems: 'center' }}>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '0.7rem', color: T.textMuted, marginBottom: '0.25rem', textTransform: 'uppercase', fontWeight: '600' }}>Equity</div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: '700', color: T.blue }}>
                                            ${(() => {
                                                const openTrades = trades.filter(t => !t.exitDate);
                                                return openTrades.reduce((sum, trade) => {
                                                    const currentPrice = manualPrices[trade.symbol] || currentPrices[trade.symbol] || trade.entryPrice;
                                                    return sum + (trade.qty * currentPrice) + (trade.dividend || 0);
                                                }, 0).toFixed(2);
                                            })()}
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '0.7rem', color: T.textMuted, marginBottom: '0.25rem', textTransform: 'uppercase', fontWeight: '600' }}>Today's P/L</div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: '700', color: metrics.todaysPL >= 0 ? T.green : T.red }}>
                                            {metrics.todaysPL >= 0 ? '+' : ''}${metrics.todaysPL.toFixed(2)}
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ fontSize: '0.7rem', color: T.textMuted, marginBottom: '0.25rem', textTransform: 'uppercase', fontWeight: '600' }}>Unrealized P/L</div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: '700', color: metrics.unrealizedPL >= 0 ? T.green : T.red }}>
                                            {metrics.unrealizedPL >= 0 ? '+' : ''}${metrics.unrealizedPL.toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                    <button onClick={() => setTradeView('all')} style={{ background: tradeView === 'all' ? T.green : 'transparent', color: tradeView === 'all' ? T.pageBg : T.textMuted, border: `1px solid ${tradeView === 'all' ? T.green : T.borderStrong}`, padding: '0.5rem 1rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600' }}>All ({filteredTrades.length})</button>
                                    <button onClick={() => setTradeView('open')} style={{ background: tradeView === 'open' ? T.green : 'transparent', color: tradeView === 'open' ? T.pageBg : T.textMuted, border: `1px solid ${tradeView === 'open' ? T.green : T.borderStrong}`, padding: '0.5rem 1rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600' }}>Open ({filteredTrades.filter(t => !t.exitDate).length})</button>
                                    <button onClick={() => setTradeView('closed')} style={{ background: tradeView === 'closed' ? T.green : 'transparent', color: tradeView === 'closed' ? T.pageBg : T.textMuted, border: `1px solid ${tradeView === 'closed' ? T.green : T.borderStrong}`, padding: '0.5rem 1rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600' }}>Closed ({filteredTrades.filter(t => t.exitDate).length})</button>
                                </div>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    {['1M', '3M', '6M', 'YTD', '1Y', 'ALL'].map(tf => (
                                        <button key={tf} onClick={() => setTimeframe(tf)} style={{ background: timeframe === tf ? T.blue : 'transparent', color: timeframe === tf ? T.pageBg : T.textMuted, border: `1px solid ${timeframe === tf ? T.blue : T.borderStrong}`, padding: '0.5rem 1rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '0.85rem' }}>{tf}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div style={{ background: T.panelBg, borderRadius: '8px', border: `1px solid ${T.border}`, overflow: 'hidden' }}>
                            <div style={{ overflowX: 'auto' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{ background: T.surfaceBg, borderBottom: `1px solid ${T.border}` }}>
                                            <th onClick={() => handleSort('symbol')} style={{ padding: '1rem', textAlign: 'left', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Symbol {sortColumn === 'symbol' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th onClick={() => handleSort('name')} style={{ padding: '1rem', textAlign: 'left', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Name {sortColumn === 'name' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            {showSplitQtyColumns ? (
                                                <>
                                                    <th onClick={() => handleSort('originalQty')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                        Orig Qty {sortColumn === 'originalQty' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                    <th onClick={() => handleSort('qty')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                        Remaining {sortColumn === 'qty' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                    </th>
                                                </>
                                            ) : (
                                                <th onClick={() => handleSort('qty')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                    Qty {sortColumn === 'qty' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                </th>
                                            )}
                                            <th onClick={() => handleSort('entryPrice')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Avg Cost {sortColumn === 'entryPrice' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th onClick={() => handleSort('exitPrice')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                {tradeView === 'open' ? 'Last' : 'Exit'} {sortColumn === 'exitPrice' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            {showChgColumn && (
                                                <th onClick={() => handleSort('chg')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                    Chg {sortColumn === 'chg' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                </th>
                                            )}
                                            {showChgColumn && (
                                                <th onClick={() => handleSort('todaysProfit')} title="Today's profit" style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none', whiteSpace: 'nowrap' }}>
                                                    Profit <span style={{ fontSize: '0.65rem', color: T.textFaint, fontWeight: '400', borderRadius: '50%', border: `1px solid ${T.textFaint}`, padding: '0px 3px', marginLeft: '2px', verticalAlign: 'middle' }}>?</span> {sortColumn === 'todaysProfit' && (sortDirection === 'asc' ? '↑' : '↓')}
                                                </th>
                                            )}
                                            <th onClick={() => handleSort('totalChg')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Total Chg {sortColumn === 'totalChg' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th onClick={() => handleSort('changePercent')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Chg % {sortColumn === 'changePercent' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th onClick={() => handleSort('marketValue')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Market Value {sortColumn === 'marketValue' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th onClick={() => handleSort('profit')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Profit {sortColumn === 'profit' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th onClick={() => handleSort('totalProfit')} style={{ padding: '1rem', textAlign: 'right', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase', cursor: 'pointer', userSelect: 'none' }}>
                                                Total Profit {sortColumn === 'totalProfit' && (sortDirection === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th style={{ padding: '1rem', textAlign: 'left', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase' }}>Status</th>
                                            <th style={{ padding: '1rem', textAlign: 'center', fontSize: '0.75rem', color: T.textMuted, fontWeight: '600', textTransform: 'uppercase' }}>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {displayTrades.map((trade, idx) => {
                                            const isOpen = !trade.exitDate;
                                            const livePrice = currentPrices[trade.symbol];
                                            const manualPrice = manualPrices[trade.symbol];
                                            const currentPrice = isOpen
                                                ? (manualPrice || livePrice || trade.entryPrice)
                                                : (trade.exitPrice || trade.entryPrice);
                                            const priceSource = isOpen
                                                ? (manualPrice ? 'manual' : livePrice ? 'live' : 'entry')
                                                : 'closed';
                                            const liveProfit = isOpen
                                                ? (trade.direction === 'short' 
                                                    ? (trade.entryPrice - currentPrice) * trade.qty - trade.fees
                                                    : (currentPrice - trade.entryPrice) * trade.qty - trade.fees)
                                                : trade.profit;
                                            const totalProfit = liveProfit + (trade.dividend || 0);
                                            const partialExits = trade.partialExits || [];
                                            const partialExitProfit = partialExits.reduce((sum, pe) => sum + pe.profit, 0);
                                            const originalQty = trade.originalQty || trade.qty;
                                            return (
                                            <React.Fragment key={trade.id}>
                                            <tr style={{ borderBottom: `1px solid ${T.border}`, background: idx % 2 === 0 ? T.tableRowEven : T.tableRowOdd }}>
                                                <td onClick={() => (partialExits.length > 0 || (trade.partialAdds || []).length > 0) && setExpandedTrade(expandedTrade === trade.id ? null : trade.id)} style={{ padding: '1rem', fontWeight: '600', fontSize: '0.95rem', cursor: (partialExits.length > 0 || (trade.partialAdds || []).length > 0) ? 'pointer' : 'default' }}>
                                                    {trade.direction === 'short' && (
                                                        <span style={{ display: 'inline-block', background: T.redBg, color: T.red, border: `1px solid ${T.red}`, borderRadius: '3px', fontSize: '0.65rem', fontWeight: '700', padding: '1px 4px', marginRight: '0.4rem', verticalAlign: 'middle', lineHeight: '1.4' }}>S</span>
                                                    )}
                                                    {trade.symbol}
                                                </td>
                                                <td style={{ padding: '1rem', color: T.textSecondary, fontSize: '0.85rem', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{trade.name}</td>
                                                {showSplitQtyColumns ? (
                                                    <>
                                                        <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem' }}>{originalQty}</td>
                                                        <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem', color: trade.qty < originalQty ? T.amber : T.textPrimary }}>{trade.qty}</td>
                                                    </>
                                                ) : (
                                                    <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem' }}>{trade.qty}</td>
                                                )}
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem' }}>${trade.entryPrice % 1 === 0 ? trade.entryPrice.toFixed(2) : parseFloat(trade.entryPrice.toFixed(4)).toString()}</td>
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem' }}>
                                                    {isOpen ? (
                                                        editingPrice === trade.symbol ? (
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem', justifyContent: 'flex-end' }}>
                                                                <input
                                                                    type="number" step="0.01" autoFocus
                                                                    defaultValue={manualPrice || livePrice || trade.entryPrice}
                                                                    onKeyDown={(e) => {
                                                                        if (e.key === 'Enter') {
                                                                            const val = parseFloat(e.target.value);
                                                                            if (!isNaN(val) && val > 0) setManualPrices(p => ({...p, [trade.symbol]: val}));
                                                                            setEditingPrice(null);
                                                                        }
                                                                        if (e.key === 'Escape') setEditingPrice(null);
                                                                    }}
                                                                    onBlur={(e) => {
                                                                        const val = parseFloat(e.target.value);
                                                                        if (!isNaN(val) && val > 0) setManualPrices(p => ({...p, [trade.symbol]: val}));
                                                                        setEditingPrice(null);
                                                                    }}
                                                                    style={{ width: '80px', padding: '0.25rem 0.5rem', background: T.raisedBg, border: `1px solid ${T.blue}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.85rem' }}
                                                                />
                                                            </div>
                                                        ) : (
                                                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '2px' }}>
                                                                <span style={{ color: priceSource === 'live' ? T.green : priceSource === 'manual' ? T.amber : T.textMuted }}>
                                                                    ${currentPrice.toFixed(2)}
                                                                </span>
                                                                <span
                                                                    onClick={() => setEditingPrice(trade.symbol)}
                                                                    style={{ fontSize: '0.65rem', color: priceSource === 'live' ? T.green : priceSource === 'manual' ? T.amber : T.textFaint, cursor: 'pointer', textDecoration: 'underline' }}
                                                                >
                                                                    {priceSource === 'live' ? 'live ✓' : priceSource === 'manual' ? 'manual ✎' : 'click to set ✎'}
                                                                </span>
                                                            </div>
                                                        )
                                                    ) : (
                                                        <span>${currentPrice.toFixed(2)}</span>
                                                    )}
                                                </td>
                                                {showChgColumn && (
                                                    <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem', fontWeight: '600' }}>
                                                        {(() => {
                                                            if (!isOpen) return null;
                                                            const prevClose = prevClosePrices[trade.symbol];
                                                            if (!prevClose) return <span style={{ color: T.textMuted }}>-</span>;
                                                            const dayChg = trade.direction === 'short'
                                                                ? prevClose - currentPrice
                                                                : currentPrice - prevClose;
                                                            return (
                                                                <span style={{ color: dayChg >= 0 ? T.green : T.red }}>
                                                                    {dayChg >= 0 ? '+' : ''}${dayChg.toFixed(2)}
                                                                </span>
                                                            );
                                                        })()}
                                                    </td>
                                                )}
                                                {showChgColumn && (
                                                    <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem', fontWeight: '600' }}>
                                                        {(() => {
                                                            if (!isOpen) return null;
                                                            const prevClose = prevClosePrices[trade.symbol];
                                                            if (!prevClose) return <span style={{ color: T.textMuted }}>-</span>;
                                                            const dayChg = trade.direction === 'short'
                                                                ? prevClose - currentPrice
                                                                : currentPrice - prevClose;
                                                            const todaysProfit = dayChg * trade.qty;
                                                            return (
                                                                <span style={{ color: todaysProfit >= 0 ? T.green : T.red }}>
                                                                    {todaysProfit >= 0 ? '+' : ''}${todaysProfit.toFixed(2)}
                                                                </span>
                                                            );
                                                        })()}
                                                    </td>
                                                )}
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem', fontWeight: '600' }}>
                                                    {(() => {
                                                        const totalChg = trade.direction === 'short'
                                                            ? trade.entryPrice - currentPrice
                                                            : currentPrice - trade.entryPrice;
                                                        return (
                                                            <span style={{ color: totalChg >= 0 ? T.green : T.red }}>
                                                                {totalChg >= 0 ? '+' : ''}${totalChg.toFixed(2)}
                                                            </span>
                                                        );
                                                    })()}
                                                </td>
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.9rem', fontWeight: '600' }}>
                                                    {(() => {
                                                        const changePercent = trade.direction === 'short'
                                                            ? ((trade.entryPrice - currentPrice) / trade.entryPrice) * 100
                                                            : ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100;
                                                        return (
                                                            <span style={{ color: changePercent >= 0 ? T.green : T.red }}>
                                                                {changePercent >= 0 ? '+' : ''}{changePercent.toFixed(2)}%
                                                            </span>
                                                        );
                                                    })()}
                                                </td>
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.95rem', fontWeight: '600', color: T.blue }}>
                                                    ${(trade.qty * currentPrice).toFixed(2)}
                                                </td>
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.95rem', fontWeight: '600', color: liveProfit >= 0 ? T.green : T.red }}>
                                                    {liveProfit >= 0 ? '+' : ''}${liveProfit.toFixed(2)}
                                                </td>
                                                <td style={{ padding: '1rem', textAlign: 'right', fontSize: '0.95rem', fontWeight: '600', color: totalProfit >= 0 ? T.green : T.red }}>
                                                    {totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)}
                                                    {trade.dividend > 0 && <div style={{ fontSize: '0.7rem', color: T.blue, marginTop: '2px' }}>+${trade.dividend.toFixed(2)} div</div>}
                                                </td>
                                                <td style={{ padding: '1rem' }}>
                                                    <span style={{ padding: '0.25rem 0.75rem', borderRadius: '4px', fontSize: '0.75rem', fontWeight: '600',
                                                        background: isOpen ? T.blueBg : (liveProfit >= 0 ? T.greenBgDim : T.redBg),
                                                        color: isOpen ? T.blue : (liveProfit >= 0 ? T.green : T.red) }}>
                                                        {isOpen ? 'OPEN' : (liveProfit >= 0 ? 'WIN' : 'LOSS')}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '1rem', textAlign: 'center' }}>
                                                    <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
                                                        <button onClick={() => handleEditTrade(trade)} style={{ background: 'transparent', border: `1px solid ${T.borderStrong}`, color: T.blue, padding: '0.5rem', borderRadius: '4px', cursor: 'pointer' }} title="Edit"><Edit size={16} /></button>
                                                        <button onClick={() => handleDeleteTrade(trade.id)} style={{ background: 'transparent', border: `1px solid ${T.borderStrong}`, color: T.red, padding: '0.5rem', borderRadius: '4px', cursor: 'pointer' }} title="Delete"><Trash2 size={16} /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {expandedTrade === trade.id && partialExits.length > 0 && (
                                                <tr style={{ background: T.surfaceBg, borderBottom: `1px solid ${T.border}` }}>
                                                    <td colSpan="14" style={{ padding: '1rem', background: T.surfaceBg }}>
                                                        <div style={{ marginLeft: '2rem' }}>
                                                            <div style={{ fontSize: '0.75rem', color: T.textMuted, marginBottom: '0.5rem', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Trade Activity</div>
                                                            {[...partialExits.map(pe => ({...pe, type:'exit'})), ...(trade.partialAdds||[]).map(pa => ({...pa, type:'add'}))].sort((a,b) => new Date(a.exitDate||a.date) - new Date(b.exitDate||b.date)).map(item => (
                                                                item.type === 'exit' ? (
                                                                    <div key={item.id} style={{ padding: '0.35rem 0', fontSize: '0.82rem', color: T.textSecondary, display: 'flex', gap: '1.5rem', alignItems: 'center' }}>
                                                                        <span style={{ fontSize: '0.63rem', fontWeight: '700', color: T.amber, background: `${T.amber}22`, padding: '0.1rem 0.35rem', borderRadius: '2px', textTransform: 'uppercase' }}>Out</span>
                                                                        <span>{item.exitDate}</span>
                                                                        <span>{item.qty} @ ${item.exitPrice.toFixed(2)}</span>
                                                                        <span style={{ color: item.profit >= 0 ? T.green : T.red, fontWeight: '600' }}>{item.profit >= 0 ? '+' : ''}${item.profit.toFixed(2)}</span>
                                                                    </div>
                                                                ) : (
                                                                    <div key={item.id} style={{ padding: '0.35rem 0', fontSize: '0.82rem', color: T.textSecondary, display: 'flex', gap: '1.5rem', alignItems: 'center' }}>
                                                                        <span style={{ fontSize: '0.63rem', fontWeight: '700', color: T.green, background: `${T.green}22`, padding: '0.1rem 0.35rem', borderRadius: '2px', textTransform: 'uppercase' }}>In</span>
                                                                        <span>{item.date}</span>
                                                                        <span>+{item.qty} @ ${item.price.toFixed(2)}</span>
                                                                        <span style={{ color: T.textMuted, fontSize: '0.75rem' }}>avg adjusted</span>
                                                                    </div>
                                                                )
                                                            ))}
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                            </React.Fragment>
                                        )})}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {displayTrades.length === 0 && <div style={{ textAlign: 'center', padding: '3rem', color: T.textMuted }}>No trades found</div>}
                    </div>
                    {showAddTrade && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1000 }}>
                            <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '540px', width: '100%', border: `1px solid ${T.border}`, maxHeight: '90vh', overflow: 'auto' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '2rem' }}>
                                    <h3 style={{ margin: 0, fontSize: '1.5rem' }}>ADD TRADE</h3>
                                    <button onClick={() => setShowAddTrade(false)} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                </div>

                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Symbol *</label>
                                        <input type="text" placeholder="AAPL" value={formData.symbol}
                                            onChange={(e) => setFormData({...formData, symbol: e.target.value.toUpperCase()})}
                                            onBlur={async (e) => {
                                                const sym = e.target.value.trim();
                                                if (!sym) return;
                                                if (formData.name && formData.name.trim()) return;
                                                setFetchingName(true);
                                                const name = await fetchSymbolName(sym);
                                                setFetchingName(false);
                                                if (name) setFormData(prev => ({ ...prev, name }));
                                            }}
                                            style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.95rem' }} /></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600', whiteSpace: 'nowrap' }}>Direction</label>
                                        <select value={formData.direction} onChange={(e) => setFormData({...formData, direction: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: formData.direction === 'short' ? T.red : T.green, fontWeight: '600', cursor: 'pointer', fontSize: '0.9rem' }}>
                                            <option value="long" style={{ color: T.green }}>Long</option>
                                            <option value="short" style={{ color: T.red }}>Short</option>
                                        </select></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600', whiteSpace: 'nowrap' }}>Qty *</label>
                                        <input type="number" placeholder="100" value={formData.qty} onChange={(e) => setFormData({...formData, qty: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.95rem' }} /></div>
                                        </div>
                                    <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Name {fetchingName && <span style={{ color: T.textFaint, fontWeight: 400, fontSize: '0.75rem', marginLeft: '0.5rem' }}>⟳ looking up...</span>}</label>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        <input type="text" placeholder={fetchingName ? 'Fetching name...' : 'Auto-filled from symbol, or type manually'} value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={{ flex: 1, padding: '0.75rem', background: T.panelBg, border: `1px solid ${fetchingName ? T.textFaint : T.borderMid}`, borderRadius: '4px', color: T.textPrimary, transition: 'border-color 0.2s' }} />
                                        <button type="button" title="Lookup name from symbol" onClick={async () => { if (!formData.symbol) return; setFetchingName(true); const name = await fetchSymbolName(formData.symbol); setFetchingName(false); if (name) setFormData(prev => ({ ...prev, name })); else alert('Could not find name for "' + formData.symbol + '". Try entering it manually.'); }} style={{ padding: '0.75rem 0.9rem', background: T.raisedBg, border: `1px solid ${T.borderStrong}`, borderRadius: '4px', color: formData.symbol ? T.textSecondary : T.textFaint, cursor: formData.symbol ? 'pointer' : 'not-allowed', fontSize: '0.9rem' }}>🔍</button>
                                    </div></div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Entry Price *</label>
                                            <input type="number" step="0.01" placeholder="150.25" value={formData.entryPrice} onChange={(e) => setFormData({...formData, entryPrice: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Entry Date *</label>
                                            <input type="date" value={formData.entryDate} onChange={(e) => setFormData({...formData, entryDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Price</label>
                                            <input type="number" step="0.01" placeholder="160.50" value={formData.exitPrice} onChange={(e) => { const newExitPrice = e.target.value; setFormData({...formData, exitPrice: newExitPrice, exitDate: newExitPrice && !formData.exitDate ? new Date().toISOString().split("T")[0] : formData.exitDate}); }} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Date</label>
                                            <input type="date" value={formData.exitDate} onChange={(e) => setFormData({...formData, exitDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 72px', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Profit</label>
                                            <input type="number" step="0.01" value={formData.profit} onChange={(e) => setFormData({...formData, profit: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Dividends</label>
                                            <input type="number" step="0.01" value={formData.dividend} onChange={(e) => setFormData({...formData, dividend: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} />
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem', marginTop: '0.35rem' }}>
                                                {dividendAddActive ? (
                                                    <>
                                                        <input autoFocus type="number" step="0.01" placeholder="add amount" value={dividendAddVal} onChange={(e) => setDividendAddVal(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && dividendAddVal) { setFormData(prev => ({...prev, dividend: String(((parseFloat(prev.dividend) || 0) + parseFloat(dividendAddVal)).toFixed(2))})); setDividendAddVal(''); setDividendAddActive(false); } else if (e.key === 'Escape') { setDividendAddVal(''); setDividendAddActive(false); } }} style={{ flex: 1, padding: '0.28rem 0.45rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '3px', color: T.textPrimary, fontSize: '0.72rem' }} />
                                                        <button onClick={() => { if (dividendAddVal) { setFormData(prev => ({...prev, dividend: String(((parseFloat(prev.dividend) || 0) + parseFloat(dividendAddVal)).toFixed(2))})); } setDividendAddVal(''); setDividendAddActive(false); }} style={{ padding: '0.28rem 0.5rem', background: 'transparent', border: `1px solid ${T.green}`, borderRadius: '3px', color: T.green, cursor: 'pointer', fontSize: '0.72rem', lineHeight: 1 }}>&#10003;</button>
                                                        <button onClick={() => { setDividendAddVal(''); setDividendAddActive(false); }} style={{ padding: '0.28rem 0.45rem', background: 'transparent', border: `1px solid ${T.textFaint}`, borderRadius: '3px', color: T.textMuted, cursor: 'pointer', fontSize: '0.72rem', lineHeight: 1 }}>&#10005;</button>
                                                    </>
                                                ) : (
                                                    <button onClick={() => setDividendAddActive(true)} title="Add to dividend total" style={{ padding: '0.18rem 0.45rem', background: 'transparent', border: `1px solid ${T.textFaint}`, borderRadius: '3px', color: T.textMuted, cursor: 'pointer', fontSize: '0.68rem', display: 'flex', alignItems: 'center', gap: '0.2rem', lineHeight: 1 }}>
                                                        <span style={{ fontSize: '0.8rem', lineHeight: 1 }}>+</span> add
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Fees</label>
                                            <input type="number" step="0.01" value={formData.fees} onChange={(e) => setFormData({...formData, fees: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        </div>
                                    <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Notes</label>
                                        <textarea placeholder="Trade notes..." value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, minHeight: '80px', fontFamily: 'inherit' }} /></div>
                                    <button onClick={handleAddTrade} disabled={!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate} style={{ background: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? T.borderStrong : T.green, color: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? T.textMuted : T.pageBg, border: 'none', padding: '1rem', borderRadius: '4px', cursor: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? 'not-allowed' : 'pointer', fontWeight: '600', marginTop: '1rem' }}>ADD TRADE</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showEditTrade && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1000 }}>
                            <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '540px', width: '100%', border: `1px solid ${T.border}`, maxHeight: '90vh', overflow: 'auto' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '2rem' }}>
                                    <h3 style={{ margin: 0, fontSize: '1.5rem' }}>EDIT TRADE</h3>
                                    <button onClick={() => { setShowEditTrade(false); setEditingTrade(null); }} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Symbol *</label>
                                        <input type="text" placeholder="AAPL" value={formData.symbol}
                                            onChange={(e) => setFormData({...formData, symbol: e.target.value.toUpperCase()})}
                                            style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.95rem' }} /></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600', whiteSpace: 'nowrap' }}>Direction</label>
                                        <select value={formData.direction} onChange={(e) => setFormData({...formData, direction: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: formData.direction === 'short' ? T.red : T.green, fontWeight: '600', cursor: 'pointer', fontSize: '0.9rem' }}>
                                            <option value="long" style={{ color: T.green }}>Long</option>
                                            <option value="short" style={{ color: T.red }}>Short</option>
                                        </select></div>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600', whiteSpace: 'nowrap' }}>
                                                {editingTrade && (editingTrade.partialExits || []).length > 0 && editingTrade.qty < editingTrade.originalQty ? 'Rem. Qty *' : 'Qty *'}
                                            </label>
                                            <div>
                                                <input 
                                                    type="number" 
                                                    placeholder="100" 
                                                    value={formData.qty} 
                                                    onChange={(e) => setFormData({...formData, qty: e.target.value})} 
                                                    style={{ width: '100%', maxWidth: '110px', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, fontSize: '0.95rem' }} 
                                                />
                                                {editingTrade && (editingTrade.partialExits || []).length > 0 && editingTrade.qty < editingTrade.originalQty && (
                                                    <div style={{ fontSize: '0.7rem', color: T.amber, marginTop: '4px' }}>
                                                        Original: {editingTrade.originalQty}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Name {fetchingName && <span style={{ color: T.textFaint, fontWeight: 400, fontSize: '0.75rem', marginLeft: '0.5rem' }}>⟳ looking up...</span>}</label>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <input type="text" placeholder={fetchingName ? 'Fetching name...' : 'Auto-filled from symbol, or type manually'} value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} style={{ flex: 1, padding: '0.75rem', background: T.panelBg, border: `1px solid ${fetchingName ? T.textFaint : T.borderMid}`, borderRadius: '4px', color: T.textPrimary, transition: 'border-color 0.2s' }} />
                                    <button type="button" title="Lookup name from symbol" onClick={async () => { if (!formData.symbol) return; setFetchingName(true); const name = await fetchSymbolName(formData.symbol); setFetchingName(false); if (name) setFormData(prev => ({ ...prev, name })); else alert('Could not find name for "' + formData.symbol + '". Try entering it manually.'); }} style={{ padding: '0.75rem 0.9rem', background: T.raisedBg, border: `1px solid ${T.borderStrong}`, borderRadius: '4px', color: formData.symbol ? T.textSecondary : T.textFaint, cursor: formData.symbol ? 'pointer' : 'not-allowed', fontSize: '0.9rem' }}>🔍</button>
                                    </div></div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Entry Price *</label>
                                        <input type="number" step="0.01" placeholder="150.25" value={formData.entryPrice} onChange={(e) => setFormData({...formData, entryPrice: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Entry Date *</label>
                                        <input type="date" value={formData.entryDate} onChange={(e) => setFormData({...formData, entryDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Price</label>
                                        <input type="number" step="0.01" placeholder="160.50" value={formData.exitPrice} onChange={(e) => { const newExitPrice = e.target.value; setFormData({...formData, exitPrice: newExitPrice, exitDate: newExitPrice && !formData.exitDate ? new Date().toISOString().split("T")[0] : formData.exitDate}); }} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Date</label>
                                        <input type="date" value={formData.exitDate} onChange={(e) => setFormData({...formData, exitDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 72px', gap: '1rem' }}>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Profit</label>
                                        <input type="number" step="0.01" value={formData.profit} onChange={(e) => setFormData({...formData, profit: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                        <div>
                                            <label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Dividends</label>
                                            <input type="number" step="0.01" value={formData.dividend} onChange={(e) => setFormData({...formData, dividend: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} />
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem', marginTop: '0.35rem' }}>
                                                {dividendAddActive ? (
                                                    <>
                                                        <input autoFocus type="number" step="0.01" placeholder="add amount" value={dividendAddVal} onChange={(e) => setDividendAddVal(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && dividendAddVal) { setFormData(prev => ({...prev, dividend: String(((parseFloat(prev.dividend) || 0) + parseFloat(dividendAddVal)).toFixed(2))})); setDividendAddVal(''); setDividendAddActive(false); } else if (e.key === 'Escape') { setDividendAddVal(''); setDividendAddActive(false); } }} style={{ flex: 1, padding: '0.28rem 0.45rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '3px', color: T.textPrimary, fontSize: '0.72rem' }} />
                                                        <button onClick={() => { if (dividendAddVal) { setFormData(prev => ({...prev, dividend: String(((parseFloat(prev.dividend) || 0) + parseFloat(dividendAddVal)).toFixed(2))})); } setDividendAddVal(''); setDividendAddActive(false); }} style={{ padding: '0.28rem 0.5rem', background: 'transparent', border: `1px solid ${T.green}`, borderRadius: '3px', color: T.green, cursor: 'pointer', fontSize: '0.72rem', lineHeight: 1 }}>&#10003;</button>
                                                        <button onClick={() => { setDividendAddVal(''); setDividendAddActive(false); }} style={{ padding: '0.28rem 0.45rem', background: 'transparent', border: `1px solid ${T.textFaint}`, borderRadius: '3px', color: T.textMuted, cursor: 'pointer', fontSize: '0.72rem', lineHeight: 1 }}>&#10005;</button>
                                                    </>
                                                ) : (
                                                    <button onClick={() => setDividendAddActive(true)} title="Add to dividend total" style={{ padding: '0.18rem 0.45rem', background: 'transparent', border: `1px solid ${T.textFaint}`, borderRadius: '3px', color: T.textMuted, cursor: 'pointer', fontSize: '0.68rem', display: 'flex', alignItems: 'center', gap: '0.2rem', lineHeight: 1 }}>
                                                        <span style={{ fontSize: '0.8rem', lineHeight: 1 }}>+</span> add
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Fees</label>
                                        <input type="number" step="0.01" value={formData.fees} onChange={(e) => setFormData({...formData, fees: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                    </div>
                                    <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Notes</label>
                                    <textarea placeholder="Trade notes..." value={formData.notes} onChange={(e) => setFormData({...formData, notes: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary, minHeight: '80px', fontFamily: 'inherit' }} /></div>
                                    
                                    {editingTrade && ((editingTrade.partialExits || []).length > 0 || (editingTrade.partialAdds || []).length > 0) && (() => {
                                        const allActivity = [
                                            ...(editingTrade.partialExits || []).map(pe => ({ ...pe, type: 'exit' })),
                                            ...(editingTrade.partialAdds || []).map(pa => ({ ...pa, type: 'add' }))
                                        ].sort((a, b) => new Date(a.exitDate || a.date) - new Date(b.exitDate || b.date));
                                        const exitReturn = (editingTrade.partialExits || []).reduce((sum, pe) => sum + pe.profit, 0);
                                        return (
                                        <div style={{ background: T.panelBg, border: `1px solid ${T.borderStrong}`, borderRadius: '8px', padding: '1rem', marginTop: '1rem' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                                <h4 style={{ margin: 0, fontSize: '0.9rem', color: T.textSecondary, textTransform: 'uppercase', fontWeight: '600' }}>Trade Activity</h4>
                                                {(editingTrade.partialExits || []).length > 0 && (
                                                    <div style={{ fontSize: '0.8rem', color: T.textSecondary }}>
                                                        Realized: <span style={{ color: exitReturn >= 0 ? T.green : T.red, fontWeight: '600' }}>
                                                            {exitReturn >= 0 ? '+' : ''}${exitReturn.toFixed(2)}
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.6rem' }}>
                                                {allActivity.map((item, idx) => (
                                                    item.type === 'exit' ? (
                                                        <div key={item.id} style={{ background: T.surfaceBg, border: `1px solid ${item.profit >= 0 ? '#00ff8822' : '#ff444422'}`, borderRadius: '4px', padding: '0.65rem 0.75rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.2rem' }}>
                                                                    <span style={{ fontSize: '0.65rem', fontWeight: '700', color: T.amber, textTransform: 'uppercase', letterSpacing: '0.06em', background: `${T.amber}22`, padding: '0.1rem 0.4rem', borderRadius: '2px' }}>Scale Out</span>
                                                                    <span style={{ fontSize: '0.72rem', color: T.textMuted }}>{item.exitDate}</span>
                                                                </div>
                                                                <div style={{ fontSize: '0.83rem', color: T.textPrimary }}>
                                                                    <strong>{item.qty}</strong> shares @ <strong>${item.exitPrice.toFixed(2)}</strong>
                                                                    <span style={{ marginLeft: '0.6rem', color: item.profit >= 0 ? T.green : T.red, fontWeight: '600' }}>
                                                                        {item.profit >= 0 ? '+' : ''}${item.profit.toFixed(2)}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div style={{ display: 'flex', gap: '0.4rem' }}>
                                                                <button onClick={() => handleEditPartialExit(item)} style={{ background: 'transparent', border: `1px solid ${T.blue}`, color: T.blue, padding: '0.35rem', borderRadius: '4px', cursor: 'pointer' }} title="Edit"><Edit size={13} /></button>
                                                                <button onClick={() => handleDeletePartialExit(item.id)} style={{ background: 'transparent', border: `1px solid ${T.red}`, color: T.red, padding: '0.35rem', borderRadius: '4px', cursor: 'pointer' }} title="Delete"><Trash2 size={13} /></button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div key={item.id} style={{ background: T.surfaceBg, border: `1px solid ${'#00ff8822'}`, borderRadius: '4px', padding: '0.65rem 0.75rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.2rem' }}>
                                                                    <span style={{ fontSize: '0.65rem', fontWeight: '700', color: T.green, textTransform: 'uppercase', letterSpacing: '0.06em', background: `${T.green}22`, padding: '0.1rem 0.4rem', borderRadius: '2px' }}>Scale In</span>
                                                                    <span style={{ fontSize: '0.72rem', color: T.textMuted }}>{item.date}</span>
                                                                </div>
                                                                <div style={{ fontSize: '0.83rem', color: T.textPrimary }}>
                                                                    +<strong>{item.qty}</strong> shares @ <strong>${item.price.toFixed(2)}</strong>
                                                                    <span style={{ marginLeft: '0.6rem', fontSize: '0.75rem', color: T.textMuted }}>avg cost adjusted</span>
                                                                </div>
                                                            </div>
                                                            <button onClick={() => handleDeletePartialAdd(item.id)} style={{ background: 'transparent', border: `1px solid ${T.red}`, color: T.red, padding: '0.35rem', borderRadius: '4px', cursor: 'pointer' }} title="Delete"><Trash2 size={13} /></button>
                                                        </div>
                                                    )
                                                ))}
                                            </div>
                                        </div>
                                        );
                                    })()}
                                    
                                    <div style={{ display: 'flex', gap: '1rem', marginTop: '1rem' }}>
                                        <button onClick={handleUpdateTrade} disabled={!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate} style={{ flex: 1, background: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? T.borderStrong : T.blue, color: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? T.textMuted : T.pageBg, border: 'none', padding: '1rem', borderRadius: '4px', cursor: (!formData.symbol || !formData.qty || !formData.entryPrice || !formData.entryDate) ? 'not-allowed' : 'pointer', fontWeight: '600' }}>UPDATE TRADE</button>
                                        <button onClick={() => { setEditingPartialExit(null); setPartialExitForm({ qty: '', exitPrice: '', exitDate: new Date().toISOString().split('T')[0] }); setPartialAddForm({ qty: '', price: '', date: new Date().toISOString().split('T')[0] }); setPartialType('exit'); setShowPartialExit(true); }} style={{ background: T.amber, color: T.pageBg, border: 'none', padding: '1rem 1.5rem', borderRadius: '4px', cursor: 'pointer', fontWeight: '600' }}>PARTIAL</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showPartialExit && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1001 }}>
                            <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '460px', width: '100%', border: `1px solid ${T.border}` }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                    <h3 style={{ margin: 0, fontSize: '1.5rem' }}>
                                        {editingPartialExit ? 'EDIT PARTIAL EXIT' : 'PARTIAL'}
                                    </h3>
                                    <button onClick={() => { setShowPartialExit(false); setEditingPartialExit(null); setPartialExitForm({ qty: '', exitPrice: '', exitDate: new Date().toISOString().split('T')[0] }); setPartialAddForm({ qty: '', price: '', date: new Date().toISOString().split('T')[0] }); }} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                </div>

                                {!editingPartialExit && (
                                    <div style={{ display: 'flex', gap: '0', marginBottom: '1.5rem', border: `1px solid ${T.borderStrong}`, borderRadius: '4px', overflow: 'hidden' }}>
                                        <button onClick={() => setPartialType('exit')} style={{ flex: 1, padding: '0.6rem', background: partialType === 'exit' ? T.amber : 'transparent', color: partialType === 'exit' ? T.pageBg : T.textMuted, border: 'none', cursor: 'pointer', fontWeight: '600', fontSize: '0.8rem', letterSpacing: '0.05em' }}>SCALE OUT</button>
                                        <button onClick={() => setPartialType('add')} style={{ flex: 1, padding: '0.6rem', background: partialType === 'add' ? T.green : 'transparent', color: partialType === 'add' ? T.pageBg : T.textMuted, border: 'none', borderLeft: `1px solid ${T.borderStrong}`, cursor: 'pointer', fontWeight: '600', fontSize: '0.8rem', letterSpacing: '0.05em' }}>SCALE IN</button>
                                    </div>
                                )}

                                {(editingPartialExit || partialType === 'exit') ? (
                                    <>
                                        <div style={{ marginBottom: '1.25rem', color: T.textSecondary, fontSize: '0.85rem' }}>
                                            Remaining: <strong style={{ color: T.green }}>{editingTrade?.qty || 0}</strong> of {editingTrade?.originalQty || editingTrade?.qty || 0} shares
                                        </div>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Shares to Exit *</label>
                                            <input type="number" placeholder="10" value={partialExitForm.qty} onChange={(e) => setPartialExitForm({...partialExitForm, qty: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Price *</label>
                                            <input type="number" step="0.01" placeholder="155.50" value={partialExitForm.exitPrice} onChange={(e) => setPartialExitForm({...partialExitForm, exitPrice: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Exit Date *</label>
                                            <input type="date" value={partialExitForm.exitDate} onChange={(e) => setPartialExitForm({...partialExitForm, exitDate: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <button 
                                                onClick={editingPartialExit ? handleUpdatePartialExit : handleAddPartialExit} 
                                                disabled={!partialExitForm.qty || !partialExitForm.exitPrice || !partialExitForm.exitDate} 
                                                style={{ background: (!partialExitForm.qty || !partialExitForm.exitPrice || !partialExitForm.exitDate) ? T.borderStrong : T.amber, color: (!partialExitForm.qty || !partialExitForm.exitPrice || !partialExitForm.exitDate) ? T.textMuted : T.pageBg, border: 'none', padding: '1rem', borderRadius: '4px', cursor: (!partialExitForm.qty || !partialExitForm.exitPrice || !partialExitForm.exitDate) ? 'not-allowed' : 'pointer', fontWeight: '600', marginTop: '0.5rem' }}
                                            >
                                                {editingPartialExit ? 'UPDATE PARTIAL EXIT' : 'ADD PARTIAL EXIT'}
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div style={{ marginBottom: '1.25rem', color: T.textSecondary, fontSize: '0.85rem' }}>
                                            Current: <strong style={{ color: T.blue }}>{editingTrade?.qty || 0}</strong> shares @ <strong style={{ color: T.blue }}>${parseFloat((editingTrade?.entryPrice || 0).toFixed(4))}</strong> avg cost
                                        </div>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Shares to Add *</label>
                                            <input type="number" placeholder="50" value={partialAddForm.qty} onChange={(e) => setPartialAddForm({...partialAddForm, qty: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <div>
                                                <label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Price Per Share *</label>
                                                <input type="number" step="0.01" placeholder="148.00" value={partialAddForm.price} onChange={(e) => setPartialAddForm({...partialAddForm, price: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} />
                                                {partialAddForm.qty && partialAddForm.price && editingTrade && (
                                                    <div style={{ marginTop: '0.4rem', fontSize: '0.75rem', color: T.textMuted }}>
                                                        New avg cost: <strong style={{ color: T.blue }}>
                                                            ${parseFloat((((editingTrade.qty * editingTrade.entryPrice) + (parseFloat(partialAddForm.qty) * parseFloat(partialAddForm.price))) / (editingTrade.qty + parseFloat(partialAddForm.qty))).toFixed(4))}
                                                        </strong> · New qty: <strong style={{ color: T.blue }}>{editingTrade.qty + parseFloat(partialAddForm.qty)}</strong>
                                                    </div>
                                                )}
                                            </div>
                                            <div><label style={{ display: 'block', marginBottom: '0.5rem', color: T.textSecondary, fontSize: '0.85rem', textTransform: 'uppercase', fontWeight: '600' }}>Date *</label>
                                            <input type="date" value={partialAddForm.date} onChange={(e) => setPartialAddForm({...partialAddForm, date: e.target.value})} style={{ width: '100%', padding: '0.75rem', background: T.panelBg, border: `1px solid ${T.borderMid}`, borderRadius: '4px', color: T.textPrimary }} /></div>
                                            <button 
                                                onClick={handleAddPartialAdd}
                                                disabled={!partialAddForm.qty || !partialAddForm.price || !partialAddForm.date}
                                                style={{ background: (!partialAddForm.qty || !partialAddForm.price || !partialAddForm.date) ? T.borderStrong : T.green, color: (!partialAddForm.qty || !partialAddForm.price || !partialAddForm.date) ? T.textMuted : T.pageBg, border: 'none', padding: '1rem', borderRadius: '4px', cursor: (!partialAddForm.qty || !partialAddForm.price || !partialAddForm.date) ? 'not-allowed' : 'pointer', fontWeight: '600', marginTop: '0.5rem' }}
                                            >
                                                ADD TO POSITION
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {showCSVUpload && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: T.modalOverlay, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem', zIndex: 1000 }}>
                            <div style={{ background: T.surfaceBg, borderRadius: '8px', padding: '2rem', maxWidth: '600px', width: '100%', border: `1px solid ${T.border}` }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '2rem' }}>
                                    <h3 style={{ margin: 0, fontSize: '1.5rem' }}>UPLOAD CSV</h3>
                                    <button onClick={() => setShowCSVUpload(false)} style={{ background: 'transparent', border: 'none', color: T.textMuted, cursor: 'pointer' }}><X size={24} /></button>
                                </div>
                                <div style={{ marginBottom: '1.5rem', color: T.textSecondary, fontSize: '0.9rem', lineHeight: '1.6' }}>
                                    <strong style={{ color: T.green }}>Expected CSV format:</strong><br/><br/>
                                    <strong>Required:</strong> Symbol, Qty, Entry Price, Entry Date<br/>
                                    <strong>Optional:</strong> Name, Exit Date, Total Chg, Fees, Total Profit, Log<br/><br/>
                                    <em style={{ fontSize: '0.85rem', color: T.textMuted }}>Note: If no exit price is provided, it will be calculated from Total Chg</em>
                                </div>
                                <label style={{ display: 'block', padding: '3rem', border: `2px dashed ${T.borderStrong}`, borderRadius: '8px', textAlign: 'center', cursor: processingCSV ? 'not-allowed' : 'pointer' }}>
                                    <input type="file" accept=".csv" onChange={handleCSVUpload} disabled={processingCSV} style={{ display: 'none' }} />
                                    <Upload size={48} style={{ margin: '0 auto 1rem', display: 'block', color: T.blue }} />
                                    <div style={{ fontSize: '1.1rem', fontWeight: '600', marginBottom: '0.5rem' }}>
                                        {processingCSV ? 'Processing...' : 'Click to upload CSV'}
                                    </div>
                                </label>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PortfolioTracker />);
    </script>
</body>
</html>
